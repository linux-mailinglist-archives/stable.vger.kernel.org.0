Return-Path: <stable-owner@vger.kernel.org>
X-Original-To: lists+stable@lfdr.de
Delivered-To: lists+stable@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id B4DA4210415
	for <lists+stable@lfdr.de>; Wed,  1 Jul 2020 08:45:21 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727911AbgGAGpU (ORCPT <rfc822;lists+stable@lfdr.de>);
        Wed, 1 Jul 2020 02:45:20 -0400
Received: from mx2.suse.de ([195.135.220.15]:34030 "EHLO mx2.suse.de"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S1726144AbgGAGpT (ORCPT <rfc822;stable@vger.kernel.org>);
        Wed, 1 Jul 2020 02:45:19 -0400
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.221.27])
        by mx2.suse.de (Postfix) with ESMTP id E7CDAADC5;
        Wed,  1 Jul 2020 06:45:17 +0000 (UTC)
Date:   Wed, 01 Jul 2020 08:45:16 +0200
Message-ID: <s5himf7g2df.wl-tiwai@suse.de>
From:   Takashi Iwai <tiwai@suse.de>
To:     Greg KH <greg@kroah.com>
Cc:     Sasha Levin <sashal@kernel.org>,
        Alexander Tsoy <alexander@tsoy.me>,
        linux-kernel@vger.kernel.org, stable@vger.kernel.org,
        Takashi Iwai <tiwai@suse.de>
Subject: Re: [PATCH 4.9 026/191] ALSA: usb-audio: Improve frames size computation
In-Reply-To: <20200630183328.GA1916087@kroah.com>
References: <20200629154007.2495120-1-sashal@kernel.org>
        <20200629154007.2495120-27-sashal@kernel.org>
        <e033669a50b53e439f5071ad12d05c2d02ab6cfc.camel@tsoy.me>
        <20200630165407.GZ1931@sasha-vm>
        <20200630183328.GA1916087@kroah.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI/1.14.6 (Maruoka)
 FLIM/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL/10.8 Emacs/25.3
 (x86_64-suse-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit
Sender: stable-owner@vger.kernel.org
Precedence: bulk
List-ID: <stable.vger.kernel.org>
X-Mailing-List: stable@vger.kernel.org

On Tue, 30 Jun 2020 20:33:28 +0200,
Greg KH wrote:
> 
> On Tue, Jun 30, 2020 at 12:54:07PM -0400, Sasha Levin wrote:
> > On Tue, Jun 30, 2020 at 01:49:50PM +0300, Alexander Tsoy wrote:
> > > В Пн, 29/06/2020 в 11:37 -0400, Sasha Levin пишет:
> > > > From: Alexander Tsoy <alexander@tsoy.me>
> > > > 
> > > > [ Upstream commit f0bd62b64016508938df9babe47f65c2c727d25c ]
> > > > 
> > > > For computation of the the next frame size current value of fs/fps
> > > > and
> > > > accumulated fractional parts of fs/fps are used, where values are
> > > > stored
> > > > in Q16.16 format. This is quite natural for computing frame size for
> > > > asynchronous endpoints driven by explicit feedback, since in this
> > > > case
> > > > fs/fps is a value provided by the feedback endpoint and it's already
> > > > in
> > > > the Q format. If an error is accumulated over time, the device can
> > > > adjust fs/fps value to prevent buffer overruns/underruns.
> > > > 
> > > > But for synchronous endpoints the accuracy provided by these
> > > > computations
> > > > is not enough. Due to accumulated error the driver periodically
> > > > produces
> > > > frames with incorrect size (+/- 1 audio sample).
> > > > 
> > > > This patch fixes this issue by implementing a different algorithm for
> > > > frame size computation. It is based on accumulating of the remainders
> > > > from division fs/fps and it doesn't accumulate errors over time. This
> > > > new method is enabled for synchronous and adaptive playback
> > > > endpoints.
> > > > 
> > > > Signed-off-by: Alexander Tsoy <alexander@tsoy.me>
> > > > Link:
> > > > https://lore.kernel.org/r/20200424022449.14972-1-alexander@tsoy.me
> > > > Signed-off-by: Takashi Iwai <tiwai@suse.de>
> > > > Signed-off-by: Sasha Levin <sashal@kernel.org>
> > > > ---
> > > >  sound/usb/card.h     |  4 ++++
> > > >  sound/usb/endpoint.c | 43 ++++++++++++++++++++++++++++++++++++++--
> > > > ---
> > > >  sound/usb/endpoint.h |  1 +
> > > >  sound/usb/pcm.c      |  2 ++
> > > >  4 files changed, 45 insertions(+), 5 deletions(-)
> > > 
> > > Please drop this patch from the queue for now (and for 4.4 as well). It
> > > introduced a regression for some devices. The fix is available, but not
> > > accepted yet.
> > 
> > I've dropped it from the older branches, but note that it's already in
> > newer released stable kernels. Should it be reverted or should we wait
> > for the fix?
> 
> I was going to wait for the fix.

The corresponding fix is now in sound git tree.
But since I'm traveling in this week, the pull request to Linus will
be delayed likely to the next week.


thanks,

Takashi
