Return-Path: <stable-owner@vger.kernel.org>
X-Original-To: lists+stable@lfdr.de
Delivered-To: lists+stable@lfdr.de
Received: from out1.vger.email (out1.vger.email [IPv6:2620:137:e000::1:20])
	by mail.lfdr.de (Postfix) with ESMTP id 584474ED1AF
	for <lists+stable@lfdr.de>; Thu, 31 Mar 2022 04:25:13 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229759AbiCaC0E (ORCPT <rfc822;lists+stable@lfdr.de>);
        Wed, 30 Mar 2022 22:26:04 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:52618 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229720AbiCaC0D (ORCPT
        <rfc822;stable@vger.kernel.org>); Wed, 30 Mar 2022 22:26:03 -0400
Received: from mout.gmx.net (mout.gmx.net [212.227.17.21])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 7F56D6A003
        for <stable@vger.kernel.org>; Wed, 30 Mar 2022 19:24:15 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=gmx.net;
        s=badeba3b8450; t=1648693445;
        bh=uKKtUUk+yJGymUNEz1TQy4hpDMYLIIufa4LVxtki3M8=;
        h=X-UI-Sender-Class:From:To:Cc:Subject:Date;
        b=YhfLA6495CXuwUo1kSr6+XnWs9JDuWnQZwp2FXpA7mcP4XaF7f7HoOqP8SXgseL2T
         /NuiIG3GbP2Q2UbIlKL0Mjhqv5Ja4h4Dew39BVjmwqefdBHEerpUjvRnGWeuHnPLao
         /hbcnyK8MWiwZ3L4LN/OBowCu4A1nMuFeqi82/0A=
X-UI-Sender-Class: 01bb95c1-4bf8-414a-932a-4f6e2808ef9c
Received: from Venus.fritz.box ([46.223.2.105]) by mail.gmx.net (mrgmx104
 [212.227.17.168]) with ESMTPSA (Nemesis) id 1MrhQC-1oLCj23qWy-00neqZ; Thu, 31
 Mar 2022 04:24:05 +0200
From:   Lino Sanfilippo <LinoSanfilippo@gmx.de>
To:     gregkh@linuxfoundation.org
Cc:     LinoSanfilippo@gmx.de, jarkko@kernel.org, jgg@nvidia.com,
        jgg@ziepe.ca, stable@vger.kernel.org, stefanb@linux.ibm.com
Subject: [PATCH for-4.19] tpm: fix reference counting for struct tpm_chip
Date:   Thu, 31 Mar 2022 04:24:00 +0200
Message-Id: <20220331022400.1891-1-LinoSanfilippo@gmx.de>
X-Mailer: git-send-email 2.35.1
MIME-Version: 1.0
Content-Transfer-Encoding: base64
X-Provags-ID: V03:K1:B441SMcum/XNhkQH6XrIt29LI0rxk3YuSMuwYlBzPxeMZev6lS2
 bus0XmjOVuBHGqK4GH9p6oE3EIFhDBQwWQapUrkXlm/x56BmGqhR9+dBI48j0vEBhoAixAJ
 cFOPA4M5YhENjcW8n4YDHxQVa5k3hA9bXgfnIZj14WuWFS9zHrYvm1tVhfiWOlSESTx3d1M
 KY6vk7ZsjFJYhzSdwj+0Q==
X-UI-Out-Filterresults: notjunk:1;V03:K0:z9i3VqE5yBY=:4ETDFGCMRAV6aJGc5WAxuU
 zqcaVmRSpGaMGB7VEKzrgMDzfS/bUKveqoDhzuJNtp+eW+9Ob4bQE6YfMJsOnwkmqpUknoUPH
 0vM4Jud47nDEUXla4Xl1cfSTKTb5j+sa+AxFP5uAgXAD1xs7iIkZZJZcCX+4MZRwUrWxQFmXx
 ivq8YDikpvfAEMCf2N5CnEsGd984g6O5gxr3zKRvKgiqoZvWfOkSGhtJdiF1voKsdKfV9zb9U
 hjf8n5Q4/xZF2fnblB29hLaN7VmOuly5ngG8h0f7cKIjx1k154ujuSBpH2qyPImRYLq9LtNpu
 AhqtKiXk+IQdgoNfzJubZRW69wpKNVEoxL+YFE+MZcSG+Opldwcy0jWqmtaardXin1xg8IRVL
 WYRJCpDO4RzTSj7O8LOHWOUdJez4sRL2YUfmQgCHHy5+Rh4hwwh6zw4BhYK+jnsREnw4ukSbC
 VHQvNEs9krBA20RwHG5OyPnOLYD3/yyuf0memZmN1keqCkWXnXB/a8qkpnhJHOA11qqWnEC4D
 qFKmxrk/EsFY7Jl4qLHAUW4Utrv1NAfxmfuvw0KfhUH9ZAii7lug2TMIyLQW7UAixLjW/uTCu
 TGd4gxaTY8i+8bNTD3U5DVNLJlPHwpqn6xBrrLYFvse7UwlB/BlGxqnnz4tFaOpJG9IBNlWdH
 MMx9bgjttcLT9qPkcstpJ4Cm4KEJJRyEAEGQUnFdLC1XKVXJFeji/2JklLYQNe+/VHN0Se0bx
 s7jgy+RISFunaE+4sshJVR4zIa7qb7eUw9r64GSbz3uveX1MJ//0xxhBdPXIgtVbE+NtETQzO
 H/0uzVrLKhrKgCxWoakRy28iU1pMcVn+4rOjEoo+CvYGGThV9X8joyX/f1z4Y4DqcPXcbUSTA
 1wDiZAsQ7ufMHY2411I80jy8LVYHg2NDsCjJEFw75dfnaxmg9jJiuqNIAQSLivfbAsxrQmcxJ
 L6Z7MWeTBeszhaXbkSismjyksvZG6vHFYaxPDwNKDMwL3bluN8SZ4ODiQcmogI0KYWdOcDj6w
 TgtvFj9IzpKBoaTYm4CNzVL9BDTSo2Xx2QSNccCbmTCsNNJ+7Sy8gwelgw3nv+gHy4So5tyqB
 3orIWYUCzWS2TUPvhEAE8CwMZZ9ihcoxmqv
X-Spam-Status: No, score=2.5 required=5.0 tests=BAYES_00,DKIM_SIGNED,
        DKIM_VALID,FREEMAIL_FROM,MIME_BASE64_TEXT,RCVD_IN_DNSWL_LOW,
        RCVD_IN_MSPIKE_H4,RCVD_IN_MSPIKE_WL,RCVD_IN_SBL_CSS,SPF_HELO_NONE,
        SPF_PASS,T_SCC_BODY_TEXT_LINE autolearn=no autolearn_force=no
        version=3.4.6
X-Spam-Level: **
X-Spam-Checker-Version: SpamAssassin 3.4.6 (2021-04-09) on
        lindbergh.monkeyblade.net
Precedence: bulk
List-ID: <stable.vger.kernel.org>
X-Mailing-List: stable@vger.kernel.org

Y29tbWl0IDdlMDQzOGY4M2RjNzY5NDY1ZWU2NjNiYjVkY2Y4Y2MxNTQ5NDA3MTIgdXBzdHJlYW0u
CgpUaGUgZm9sbG93aW5nIHNlcXVlbmNlIG9mIG9wZXJhdGlvbnMgcmVzdWx0cyBpbiBhIHJlZmNv
dW50IHdhcm5pbmc6CgoxLiBPcGVuIGRldmljZSAvZGV2L3RwbXJtLgoyLiBSZW1vdmUgbW9kdWxl
IHRwbV90aXNfc3BpLgozLiBXcml0ZSBhIFRQTSBjb21tYW5kIHRvIHRoZSBmaWxlIGRlc2NyaXB0
b3Igb3BlbmVkIGF0IHN0ZXAgMS4KCi0tLS0tLS0tLS0tLVsgY3V0IGhlcmUgXS0tLS0tLS0tLS0t
LQpXQVJOSU5HOiBDUFU6IDMgUElEOiAxMTYxIGF0IGxpYi9yZWZjb3VudC5jOjI1IGtvYmplY3Rf
Z2V0KzB4YTAvMHhhNApyZWZjb3VudF90OiBhZGRpdGlvbiBvbiAwOyB1c2UtYWZ0ZXItZnJlZS4K
TW9kdWxlcyBsaW5rZWQgaW46IHRwbV90aXNfc3BpIHRwbV90aXNfY29yZSB0cG0gbWRpb19iY21f
dW5pbWFjIGJyY21mbWFjCnNoYTI1Nl9nZW5lcmljIGxpYnNoYTI1NiBzaGEyNTZfYXJtIGhjaV91
YXJ0IGJ0YmNtIGJsdWV0b290aCBjZmc4MDIxMSB2YzQKYnJjbXV0aWwgZWNkaF9nZW5lcmljIGVj
YyBzbmRfc29jX2NvcmUgY3JjMzJfYXJtX2NlIGxpYmFlcwpyYXNwYmVycnlwaV9od21vbiBhYzk3
X2J1cyBzbmRfcGNtX2RtYWVuZ2luZSBiY20yNzExX3RoZXJtYWwgc25kX3BjbQpzbmRfdGltZXIg
Z2VuZXQgc25kIHBoeV9nZW5lcmljIHNvdW5kY29yZSBbbGFzdCB1bmxvYWRlZDogc3BpX2JjbTI4
MzVdCkNQVTogMyBQSUQ6IDExNjEgQ29tbTogaG9sZF9vcGVuIE5vdCB0YWludGVkIDUuMTAuMGxz
LW1haW4tZGlydHkgIzIKSGFyZHdhcmUgbmFtZTogQkNNMjcxMQpbPGMwNDEwYzNjPl0gKHVud2lu
ZF9iYWNrdHJhY2UpIGZyb20gWzxjMDQwYjU4MD5dIChzaG93X3N0YWNrKzB4MTAvMHgxNCkKWzxj
MDQwYjU4MD5dIChzaG93X3N0YWNrKSBmcm9tIFs8YzEwOTIxNzQ+XSAoZHVtcF9zdGFjaysweGM0
LzB4ZDgpCls8YzEwOTIxNzQ+XSAoZHVtcF9zdGFjaykgZnJvbSBbPGMwNDQ1YTMwPl0gKF9fd2Fy
bisweDEwNC8weDEwOCkKWzxjMDQ0NWEzMD5dIChfX3dhcm4pIGZyb20gWzxjMDQ0NWFhOD5dICh3
YXJuX3Nsb3dwYXRoX2ZtdCsweDc0LzB4YjgpCls8YzA0NDVhYTg+XSAod2Fybl9zbG93cGF0aF9m
bXQpIGZyb20gWzxjMDg0MzVkMD5dIChrb2JqZWN0X2dldCsweGEwLzB4YTQpCls8YzA4NDM1ZDA+
XSAoa29iamVjdF9nZXQpIGZyb20gWzxiZjBhNzE1Yz5dICh0cG1fdHJ5X2dldF9vcHMrMHgxNC8w
eDU0IFt0cG1dKQpbPGJmMGE3MTVjPl0gKHRwbV90cnlfZ2V0X29wcyBbdHBtXSkgZnJvbSBbPGJm
MGE3ZDZjPl0gKHRwbV9jb21tb25fd3JpdGUrMHgzOC8weDYwIFt0cG1dKQpbPGJmMGE3ZDZjPl0g
KHRwbV9jb21tb25fd3JpdGUgW3RwbV0pIGZyb20gWzxjMDVhN2FjMD5dICh2ZnNfd3JpdGUrMHhj
NC8weDNjMCkKWzxjMDVhN2FjMD5dICh2ZnNfd3JpdGUpIGZyb20gWzxjMDVhN2VlND5dIChrc3lz
X3dyaXRlKzB4NTgvMHhjYykKWzxjMDVhN2VlND5dIChrc3lzX3dyaXRlKSBmcm9tIFs8YzA0MDAx
YTA+XSAocmV0X2Zhc3Rfc3lzY2FsbCsweDAvMHg0YykKRXhjZXB0aW9uIHN0YWNrKDB4YzIyNmJm
YTggdG8gMHhjMjI2YmZmMCkKYmZhMDogICAgICAgICAgICAgICAgICAgMDAwMDAwMDAgMDAwMTA1
YjQgMDAwMDAwMDMgYmVhZmU2NjQgMDAwMDAwMTQgMDAwMDAwMDAKYmZjMDogMDAwMDAwMDAgMDAw
MTA1YjQgMDAwMTAzZjggMDAwMDAwMDQgMDAwMDAwMDAgMDAwMDAwMDAgYjZmOWMwMDAgYmVhZmU2
ODQKYmZlMDogMDAwMDAwNmMgYmVhZmU2NDggMDAwMTA1NmMgYjZlYjY5NDQKLS0tWyBlbmQgdHJh
Y2UgZDRiODQwOWRlZjliOGIxZiBdLS0tCgpUaGUgcmVhc29uIGZvciB0aGlzIHdhcm5pbmcgaXMg
dGhlIGF0dGVtcHQgdG8gZ2V0IHRoZSBjaGlwLT5kZXYgcmVmZXJlbmNlCmluIHRwbV9jb21tb25f
d3JpdGUoKSBhbHRob3VnaCB0aGUgcmVmZXJlbmNlIGNvdW50ZXIgaXMgYWxyZWFkeSB6ZXJvLgoK
U2luY2UgY29tbWl0IDg5NzliMDJhYWYxZCAoInRwbTogRml4IHJlZmVyZW5jZSBjb3VudCB0byBt
YWluIGRldmljZSIpIHRoZQpleHRyYSByZWZlcmVuY2UgdXNlZCB0byBwcmV2ZW50IGEgcHJlbWF0
dXJlIHplcm8gY291bnRlciBpcyBuZXZlciB0YWtlbiwKYmVjYXVzZSB0aGUgcmVxdWlyZWQgVFBN
X0NISVBfRkxBR19UUE0yIGZsYWcgaXMgbmV2ZXIgc2V0LgoKRml4IHRoaXMgYnkgbW92aW5nIHRo
ZSBUUE0gMiBjaGFyYWN0ZXIgZGV2aWNlIGhhbmRsaW5nIGZyb20KdHBtX2NoaXBfYWxsb2MoKSB0
byB0cG1fYWRkX2NoYXJfZGV2aWNlKCkgd2hpY2ggaXMgY2FsbGVkIGF0IGEgbGF0ZXIgcG9pbnQK
aW4gdGltZSB3aGVuIHRoZSBmbGFnIGhhcyBiZWVuIHNldCBpbiBjYXNlIG9mIFRQTTIuCgpDb21t
aXQgZmRjOTE1ZjdmNzE5ICgidHBtOiBleHBvc2Ugc3BhY2VzIHZpYSBhIGRldmljZSBsaW5rIC9k
ZXYvdHBtcm08bj4iKQphbHJlYWR5IGludHJvZHVjZWQgZnVuY3Rpb24gdHBtX2RldnNfcmVsZWFz
ZSgpIHRvIHJlbGVhc2UgdGhlIGV4dHJhCnJlZmVyZW5jZSBidXQgZGlkIG5vdCBpbXBsZW1lbnQg
dGhlIHJlcXVpcmVkIHB1dCBvbiBjaGlwLT5kZXZzIHRoYXQgcmVzdWx0cwppbiB0aGUgY2FsbCBv
ZiB0aGlzIGZ1bmN0aW9uLgoKRml4IHRoaXMgYnkgcHV0dGluZyBjaGlwLT5kZXZzIGluIHRwbV9j
aGlwX3VucmVnaXN0ZXIoKS4KCkZpbmFsbHkgbW92ZSB0aGUgbmV3IGltcGxlbWVudGF0aW9uIGZv
ciB0aGUgVFBNIDIgaGFuZGxpbmcgaW50byBhIG5ldwpmdW5jdGlvbiB0byBhdm9pZCBtdWx0aXBs
ZSBjaGVja3MgZm9yIHRoZSBUUE1fQ0hJUF9GTEFHX1RQTTIgZmxhZyBpbiB0aGUKZ29vZCBjYXNl
IGFuZCBlcnJvciBjYXNlcy4KCkNjOiBzdGFibGVAdmdlci5rZXJuZWwub3JnCkZpeGVzOiBmZGM5
MTVmN2Y3MTkgKCJ0cG06IGV4cG9zZSBzcGFjZXMgdmlhIGEgZGV2aWNlIGxpbmsgL2Rldi90cG1y
bTxuPiIpCkZpeGVzOiA4OTc5YjAyYWFmMWQgKCJ0cG06IEZpeCByZWZlcmVuY2UgY291bnQgdG8g
bWFpbiBkZXZpY2UiKQpDby1kZXZlbG9wZWQtYnk6IEphc29uIEd1bnRob3JwZSA8amdnQHppZXBl
LmNhPgpTaWduZWQtb2ZmLWJ5OiBKYXNvbiBHdW50aG9ycGUgPGpnZ0B6aWVwZS5jYT4KU2lnbmVk
LW9mZi1ieTogTGlubyBTYW5maWxpcHBvIDxMaW5vU2FuZmlsaXBwb0BnbXguZGU+ClRlc3RlZC1i
eTogU3RlZmFuIEJlcmdlciA8c3RlZmFuYkBsaW51eC5pYm0uY29tPgpSZXZpZXdlZC1ieTogSmFz
b24gR3VudGhvcnBlIDxqZ2dAbnZpZGlhLmNvbT4KUmV2aWV3ZWQtYnk6IEphcmtrbyBTYWtraW5l
biA8amFya2tvQGtlcm5lbC5vcmc+ClNpZ25lZC1vZmYtYnk6IEphcmtrbyBTYWtraW5lbiA8amFy
a2tvQGtlcm5lbC5vcmc+Ci0tLQogZHJpdmVycy9jaGFyL3RwbS90cG0tY2hpcC5jICAgfCA0NiAr
KysrKy0tLS0tLS0tLS0tLS0tLS0tLS0tCiBkcml2ZXJzL2NoYXIvdHBtL3RwbS5oICAgICAgICB8
ICAyICsrCiBkcml2ZXJzL2NoYXIvdHBtL3RwbTItc3BhY2UuYyB8IDY1ICsrKysrKysrKysrKysr
KysrKysrKysrKysrKysrKysrKysrCiAzIGZpbGVzIGNoYW5nZWQsIDc1IGluc2VydGlvbnMoKyks
IDM4IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvY2hhci90cG0vdHBtLWNoaXAu
YyBiL2RyaXZlcnMvY2hhci90cG0vdHBtLWNoaXAuYwppbmRleCBmNzlmODc3OTQyNzMuLjJkNjJh
MzY0OTQwMiAxMDA2NDQKLS0tIGEvZHJpdmVycy9jaGFyL3RwbS90cG0tY2hpcC5jCisrKyBiL2Ry
aXZlcnMvY2hhci90cG0vdHBtLWNoaXAuYwpAQCAtMTYzLDE0ICsxNjMsNiBAQCBzdGF0aWMgdm9p
ZCB0cG1fZGV2X3JlbGVhc2Uoc3RydWN0IGRldmljZSAqZGV2KQogCWtmcmVlKGNoaXApOwogfQog
Ci1zdGF0aWMgdm9pZCB0cG1fZGV2c19yZWxlYXNlKHN0cnVjdCBkZXZpY2UgKmRldikKLXsKLQlz
dHJ1Y3QgdHBtX2NoaXAgKmNoaXAgPSBjb250YWluZXJfb2YoZGV2LCBzdHJ1Y3QgdHBtX2NoaXAs
IGRldnMpOwotCi0JLyogcmVsZWFzZSB0aGUgbWFzdGVyIGRldmljZSByZWZlcmVuY2UgKi8KLQlw
dXRfZGV2aWNlKCZjaGlwLT5kZXYpOwotfQotCiAvKioKICAqIHRwbV9jbGFzc19zaHV0ZG93bigp
IC0gcHJlcGFyZSB0aGUgVFBNIGRldmljZSBmb3IgbG9zcyBvZiBwb3dlci4KICAqIEBkZXY6IGRl
dmljZSB0byB3aGljaCB0aGUgY2hpcCBpcyBhc3NvY2lhdGVkLgpAQCAtMjM0LDcgKzIyNiw2IEBA
IHN0cnVjdCB0cG1fY2hpcCAqdHBtX2NoaXBfYWxsb2Moc3RydWN0IGRldmljZSAqcGRldiwKIAlj
aGlwLT5kZXZfbnVtID0gcmM7CiAKIAlkZXZpY2VfaW5pdGlhbGl6ZSgmY2hpcC0+ZGV2KTsKLQlk
ZXZpY2VfaW5pdGlhbGl6ZSgmY2hpcC0+ZGV2cyk7CiAKIAljaGlwLT5kZXYuY2xhc3MgPSB0cG1f
Y2xhc3M7CiAJY2hpcC0+ZGV2LmNsYXNzLT5zaHV0ZG93bl9wcmUgPSB0cG1fY2xhc3Nfc2h1dGRv
d247CkBAIC0yNDIsMjkgKzIzMywxMiBAQCBzdHJ1Y3QgdHBtX2NoaXAgKnRwbV9jaGlwX2FsbG9j
KHN0cnVjdCBkZXZpY2UgKnBkZXYsCiAJY2hpcC0+ZGV2LnBhcmVudCA9IHBkZXY7CiAJY2hpcC0+
ZGV2Lmdyb3VwcyA9IGNoaXAtPmdyb3VwczsKIAotCWNoaXAtPmRldnMucGFyZW50ID0gcGRldjsK
LQljaGlwLT5kZXZzLmNsYXNzID0gdHBtcm1fY2xhc3M7Ci0JY2hpcC0+ZGV2cy5yZWxlYXNlID0g
dHBtX2RldnNfcmVsZWFzZTsKLQkvKiBnZXQgZXh0cmEgcmVmZXJlbmNlIG9uIG1haW4gZGV2aWNl
IHRvIGhvbGQgb24KLQkgKiBiZWhhbGYgb2YgZGV2cy4gIFRoaXMgaG9sZHMgdGhlIGNoaXAgc3Ry
dWN0dXJlCi0JICogd2hpbGUgY2RldnMgaXMgaW4gdXNlLiAgVGhlIGNvcnJlc3BvbmRpbmcgcHV0
Ci0JICogaXMgaW4gdGhlIHRwbV9kZXZzX3JlbGVhc2UgKFRQTTIgb25seSkKLQkgKi8KLQlpZiAo
Y2hpcC0+ZmxhZ3MgJiBUUE1fQ0hJUF9GTEFHX1RQTTIpCi0JCWdldF9kZXZpY2UoJmNoaXAtPmRl
dik7Ci0KIAlpZiAoY2hpcC0+ZGV2X251bSA9PSAwKQogCQljaGlwLT5kZXYuZGV2dCA9IE1LREVW
KE1JU0NfTUFKT1IsIFRQTV9NSU5PUik7CiAJZWxzZQogCQljaGlwLT5kZXYuZGV2dCA9IE1LREVW
KE1BSk9SKHRwbV9kZXZ0KSwgY2hpcC0+ZGV2X251bSk7CiAKLQljaGlwLT5kZXZzLmRldnQgPQot
CQlNS0RFVihNQUpPUih0cG1fZGV2dCksIGNoaXAtPmRldl9udW0gKyBUUE1fTlVNX0RFVklDRVMp
OwotCiAJcmMgPSBkZXZfc2V0X25hbWUoJmNoaXAtPmRldiwgInRwbSVkIiwgY2hpcC0+ZGV2X251
bSk7Ci0JaWYgKHJjKQotCQlnb3RvIG91dDsKLQlyYyA9IGRldl9zZXRfbmFtZSgmY2hpcC0+ZGV2
cywgInRwbXJtJWQiLCBjaGlwLT5kZXZfbnVtKTsKIAlpZiAocmMpCiAJCWdvdG8gb3V0OwogCkBA
IC0yNzIsOSArMjQ2LDcgQEAgc3RydWN0IHRwbV9jaGlwICp0cG1fY2hpcF9hbGxvYyhzdHJ1Y3Qg
ZGV2aWNlICpwZGV2LAogCQljaGlwLT5mbGFncyB8PSBUUE1fQ0hJUF9GTEFHX1ZJUlRVQUw7CiAK
IAljZGV2X2luaXQoJmNoaXAtPmNkZXYsICZ0cG1fZm9wcyk7Ci0JY2Rldl9pbml0KCZjaGlwLT5j
ZGV2cywgJnRwbXJtX2ZvcHMpOwogCWNoaXAtPmNkZXYub3duZXIgPSBUSElTX01PRFVMRTsKLQlj
aGlwLT5jZGV2cy5vd25lciA9IFRISVNfTU9EVUxFOwogCiAJcmMgPSB0cG0yX2luaXRfc3BhY2Uo
JmNoaXAtPndvcmtfc3BhY2UsIFRQTTJfU1BBQ0VfQlVGRkVSX1NJWkUpOwogCWlmIChyYykgewpA
QCAtMjg2LDcgKzI1OCw2IEBAIHN0cnVjdCB0cG1fY2hpcCAqdHBtX2NoaXBfYWxsb2Moc3RydWN0
IGRldmljZSAqcGRldiwKIAlyZXR1cm4gY2hpcDsKIAogb3V0OgotCXB1dF9kZXZpY2UoJmNoaXAt
PmRldnMpOwogCXB1dF9kZXZpY2UoJmNoaXAtPmRldik7CiAJcmV0dXJuIEVSUl9QVFIocmMpOwog
fQpAQCAtMzM1LDE0ICszMDYsOSBAQCBzdGF0aWMgaW50IHRwbV9hZGRfY2hhcl9kZXZpY2Uoc3Ry
dWN0IHRwbV9jaGlwICpjaGlwKQogCX0KIAogCWlmIChjaGlwLT5mbGFncyAmIFRQTV9DSElQX0ZM
QUdfVFBNMikgewotCQlyYyA9IGNkZXZfZGV2aWNlX2FkZCgmY2hpcC0+Y2RldnMsICZjaGlwLT5k
ZXZzKTsKLQkJaWYgKHJjKSB7Ci0JCQlkZXZfZXJyKCZjaGlwLT5kZXZzLAotCQkJCSJ1bmFibGUg
dG8gY2Rldl9kZXZpY2VfYWRkKCkgJXMsIG1ham9yICVkLCBtaW5vciAlZCwgZXJyPSVkXG4iLAot
CQkJCWRldl9uYW1lKCZjaGlwLT5kZXZzKSwgTUFKT1IoY2hpcC0+ZGV2cy5kZXZ0KSwKLQkJCQlN
SU5PUihjaGlwLT5kZXZzLmRldnQpLCByYyk7Ci0JCQlyZXR1cm4gcmM7Ci0JCX0KKwkJcmMgPSB0
cG1fZGV2c19hZGQoY2hpcCk7CisJCWlmIChyYykKKwkJCWdvdG8gZXJyX2RlbF9jZGV2OwogCX0K
IAogCS8qIE1ha2UgdGhlIGNoaXAgYXZhaWxhYmxlLiAqLwpAQCAtMzUwLDYgKzMxNiwxMCBAQCBz
dGF0aWMgaW50IHRwbV9hZGRfY2hhcl9kZXZpY2Uoc3RydWN0IHRwbV9jaGlwICpjaGlwKQogCWlk
cl9yZXBsYWNlKCZkZXZfbnVtc19pZHIsIGNoaXAsIGNoaXAtPmRldl9udW0pOwogCW11dGV4X3Vu
bG9jaygmaWRyX2xvY2spOwogCisJcmV0dXJuIDA7CisKK2Vycl9kZWxfY2RldjoKKwljZGV2X2Rl
dmljZV9kZWwoJmNoaXAtPmNkZXYsICZjaGlwLT5kZXYpOwogCXJldHVybiByYzsKIH0KIApAQCAt
NTA4LDcgKzQ3OCw3IEBAIHZvaWQgdHBtX2NoaXBfdW5yZWdpc3RlcihzdHJ1Y3QgdHBtX2NoaXAg
KmNoaXApCiAJCWh3cm5nX3VucmVnaXN0ZXIoJmNoaXAtPmh3cm5nKTsKIAl0cG1fYmlvc19sb2df
dGVhcmRvd24oY2hpcCk7CiAJaWYgKGNoaXAtPmZsYWdzICYgVFBNX0NISVBfRkxBR19UUE0yKQot
CQljZGV2X2RldmljZV9kZWwoJmNoaXAtPmNkZXZzLCAmY2hpcC0+ZGV2cyk7CisJCXRwbV9kZXZz
X3JlbW92ZShjaGlwKTsKIAl0cG1fZGVsX2NoYXJfZGV2aWNlKGNoaXApOwogfQogRVhQT1JUX1NZ
TUJPTF9HUEwodHBtX2NoaXBfdW5yZWdpc3Rlcik7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2NoYXIv
dHBtL3RwbS5oIGIvZHJpdmVycy9jaGFyL3RwbS90cG0uaAppbmRleCBiOWEzMGYwYjg4MjUuLjdi
OGUyNzljMTgwYiAxMDA2NDQKLS0tIGEvZHJpdmVycy9jaGFyL3RwbS90cG0uaAorKysgYi9kcml2
ZXJzL2NoYXIvdHBtL3RwbS5oCkBAIC02MDUsNiArNjA1LDggQEAgaW50IHRwbTJfcHJlcGFyZV9z
cGFjZShzdHJ1Y3QgdHBtX2NoaXAgKmNoaXAsIHN0cnVjdCB0cG1fc3BhY2UgKnNwYWNlLCB1MzIg
Y2MsCiAJCSAgICAgICB1OCAqY21kKTsKIGludCB0cG0yX2NvbW1pdF9zcGFjZShzdHJ1Y3QgdHBt
X2NoaXAgKmNoaXAsIHN0cnVjdCB0cG1fc3BhY2UgKnNwYWNlLAogCQkgICAgICB1MzIgY2MsIHU4
ICpidWYsIHNpemVfdCAqYnVmc2l6KTsKK2ludCB0cG1fZGV2c19hZGQoc3RydWN0IHRwbV9jaGlw
ICpjaGlwKTsKK3ZvaWQgdHBtX2RldnNfcmVtb3ZlKHN0cnVjdCB0cG1fY2hpcCAqY2hpcCk7CiAK
IHZvaWQgdHBtX2Jpb3NfbG9nX3NldHVwKHN0cnVjdCB0cG1fY2hpcCAqY2hpcCk7CiB2b2lkIHRw
bV9iaW9zX2xvZ190ZWFyZG93bihzdHJ1Y3QgdHBtX2NoaXAgKmNoaXApOwpkaWZmIC0tZ2l0IGEv
ZHJpdmVycy9jaGFyL3RwbS90cG0yLXNwYWNlLmMgYi9kcml2ZXJzL2NoYXIvdHBtL3RwbTItc3Bh
Y2UuYwppbmRleCAyMDVkOTMwZDdlYTYuLmE1NGJiOTA0YjI4MSAxMDA2NDQKLS0tIGEvZHJpdmVy
cy9jaGFyL3RwbS90cG0yLXNwYWNlLmMKKysrIGIvZHJpdmVycy9jaGFyL3RwbS90cG0yLXNwYWNl
LmMKQEAgLTUzNiwzICs1MzYsNjggQEAgaW50IHRwbTJfY29tbWl0X3NwYWNlKHN0cnVjdCB0cG1f
Y2hpcCAqY2hpcCwgc3RydWN0IHRwbV9zcGFjZSAqc3BhY2UsCiAKIAlyZXR1cm4gMDsKIH0KKwor
LyoKKyAqIFB1dCB0aGUgcmVmZXJlbmNlIHRvIHRoZSBtYWluIGRldmljZS4KKyAqLworc3RhdGlj
IHZvaWQgdHBtX2RldnNfcmVsZWFzZShzdHJ1Y3QgZGV2aWNlICpkZXYpCit7CisJc3RydWN0IHRw
bV9jaGlwICpjaGlwID0gY29udGFpbmVyX29mKGRldiwgc3RydWN0IHRwbV9jaGlwLCBkZXZzKTsK
KworCS8qIHJlbGVhc2UgdGhlIG1hc3RlciBkZXZpY2UgcmVmZXJlbmNlICovCisJcHV0X2Rldmlj
ZSgmY2hpcC0+ZGV2KTsKK30KKworLyoKKyAqIFJlbW92ZSB0aGUgZGV2aWNlIGZpbGUgZm9yIGV4
cG9zZWQgVFBNIHNwYWNlcyBhbmQgcmVsZWFzZSB0aGUgZGV2aWNlCisgKiByZWZlcmVuY2UuIFRo
aXMgbWF5IGFsc28gcmVsZWFzZSB0aGUgcmVmZXJlbmNlIHRvIHRoZSBtYXN0ZXIgZGV2aWNlLgor
ICovCit2b2lkIHRwbV9kZXZzX3JlbW92ZShzdHJ1Y3QgdHBtX2NoaXAgKmNoaXApCit7CisJY2Rl
dl9kZXZpY2VfZGVsKCZjaGlwLT5jZGV2cywgJmNoaXAtPmRldnMpOworCXB1dF9kZXZpY2UoJmNo
aXAtPmRldnMpOworfQorCisvKgorICogQWRkIGEgZGV2aWNlIGZpbGUgdG8gZXhwb3NlIFRQTSBz
cGFjZXMuIEFsc28gdGFrZSBhIHJlZmVyZW5jZSB0byB0aGUKKyAqIG1haW4gZGV2aWNlLgorICov
CitpbnQgdHBtX2RldnNfYWRkKHN0cnVjdCB0cG1fY2hpcCAqY2hpcCkKK3sKKwlpbnQgcmM7CisK
KwlkZXZpY2VfaW5pdGlhbGl6ZSgmY2hpcC0+ZGV2cyk7CisJY2hpcC0+ZGV2cy5wYXJlbnQgPSBj
aGlwLT5kZXYucGFyZW50OworCWNoaXAtPmRldnMuY2xhc3MgPSB0cG1ybV9jbGFzczsKKworCS8q
CisJICogR2V0IGV4dHJhIHJlZmVyZW5jZSBvbiBtYWluIGRldmljZSB0byBob2xkIG9uIGJlaGFs
ZiBvZiBkZXZzLgorCSAqIFRoaXMgaG9sZHMgdGhlIGNoaXAgc3RydWN0dXJlIHdoaWxlIGNkZXZz
IGlzIGluIHVzZS4gVGhlCisJICogY29ycmVzcG9uZGluZyBwdXQgaXMgaW4gdGhlIHRwbV9kZXZz
X3JlbGVhc2UuCisJICovCisJZ2V0X2RldmljZSgmY2hpcC0+ZGV2KTsKKwljaGlwLT5kZXZzLnJl
bGVhc2UgPSB0cG1fZGV2c19yZWxlYXNlOworCWNoaXAtPmRldnMuZGV2dCA9IE1LREVWKE1BSk9S
KHRwbV9kZXZ0KSwgY2hpcC0+ZGV2X251bSArIFRQTV9OVU1fREVWSUNFUyk7CisJY2Rldl9pbml0
KCZjaGlwLT5jZGV2cywgJnRwbXJtX2ZvcHMpOworCWNoaXAtPmNkZXZzLm93bmVyID0gVEhJU19N
T0RVTEU7CisKKwlyYyA9IGRldl9zZXRfbmFtZSgmY2hpcC0+ZGV2cywgInRwbXJtJWQiLCBjaGlw
LT5kZXZfbnVtKTsKKwlpZiAocmMpCisJCWdvdG8gZXJyX3B1dF9kZXZzOworCisJcmMgPSBjZGV2
X2RldmljZV9hZGQoJmNoaXAtPmNkZXZzLCAmY2hpcC0+ZGV2cyk7CisJaWYgKHJjKSB7CisJCWRl
dl9lcnIoJmNoaXAtPmRldnMsCisJCQkidW5hYmxlIHRvIGNkZXZfZGV2aWNlX2FkZCgpICVzLCBt
YWpvciAlZCwgbWlub3IgJWQsIGVycj0lZFxuIiwKKwkJCWRldl9uYW1lKCZjaGlwLT5kZXZzKSwg
TUFKT1IoY2hpcC0+ZGV2cy5kZXZ0KSwKKwkJCU1JTk9SKGNoaXAtPmRldnMuZGV2dCksIHJjKTsK
KwkJZ290byBlcnJfcHV0X2RldnM7CisJfQorCisJcmV0dXJuIDA7CisKK2Vycl9wdXRfZGV2czoK
KwlwdXRfZGV2aWNlKCZjaGlwLT5kZXZzKTsKKworCXJldHVybiByYzsKK30KLS0gCjIuMzUuMQoK
