Return-Path: <stable-owner@vger.kernel.org>
X-Original-To: lists+stable@lfdr.de
Delivered-To: lists+stable@lfdr.de
Received: from out1.vger.email (out1.vger.email [IPv6:2620:137:e000::1:20])
	by mail.lfdr.de (Postfix) with ESMTP id C5A7C65D63F
	for <lists+stable@lfdr.de>; Wed,  4 Jan 2023 15:43:41 +0100 (CET)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S239548AbjADOnK (ORCPT <rfc822;lists+stable@lfdr.de>);
        Wed, 4 Jan 2023 09:43:10 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:34898 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S239695AbjADOm6 (ORCPT
        <rfc822;stable@vger.kernel.org>); Wed, 4 Jan 2023 09:42:58 -0500
Received: from smtp-out1.suse.de (smtp-out1.suse.de [IPv6:2001:67c:2178:6::1c])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 5BB11AE4C
        for <stable@vger.kernel.org>; Wed,  4 Jan 2023 06:42:57 -0800 (PST)
Received: from imap2.suse-dmz.suse.de (imap2.suse-dmz.suse.de [192.168.254.74])
        (using TLSv1.3 with cipher TLS_AES_256_GCM_SHA384 (256/256 bits)
         key-exchange X25519 server-signature ECDSA (P-521) server-digest SHA512)
        (No client certificate requested)
        by smtp-out1.suse.de (Postfix) with ESMTPS id 9513E22A27;
        Wed,  4 Jan 2023 14:42:55 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=suse.de; s=susede2_rsa;
        t=1672843375; h=from:from:reply-to:date:date:message-id:message-id:to:to:cc:cc:
         mime-version:mime-version:content-type:content-type:
         in-reply-to:in-reply-to:references:references;
        bh=nzFJhvcAaKtNtLi2BW4RFffLilfovnSQqWRntsot2xQ=;
        b=BLje2iFi5z3ZJpw2bVVq7TX5D828u/Yf04qd3XTrYrBEcTzE4y/dQjYz4kRIJ2+uyFgce7
        YEl1dFh1f03IC74OgL916COO6Baug0OUn6Ka2AhAFhxplkJRL4ikDb5raeJhuF6YqTBcmU
        wv3KW+/ut39kLG/4CoVqYJkyfdrItfk=
DKIM-Signature: v=1; a=ed25519-sha256; c=relaxed/relaxed; d=suse.de;
        s=susede2_ed25519; t=1672843375;
        h=from:from:reply-to:date:date:message-id:message-id:to:to:cc:cc:
         mime-version:mime-version:content-type:content-type:
         in-reply-to:in-reply-to:references:references;
        bh=nzFJhvcAaKtNtLi2BW4RFffLilfovnSQqWRntsot2xQ=;
        b=bsYeVPBlSfNLrAOgc9giOEjBc5UgpmE2RhFy1SPTJxvW2rwcgyMZ/Yd/JI+58F7Gn/qXFe
        JbPnMxZ7HBKc4tAw==
Received: from imap2.suse-dmz.suse.de (imap2.suse-dmz.suse.de [192.168.254.74])
        (using TLSv1.3 with cipher TLS_AES_256_GCM_SHA384 (256/256 bits)
         key-exchange X25519 server-signature ECDSA (P-521) server-digest SHA512)
        (No client certificate requested)
        by imap2.suse-dmz.suse.de (Postfix) with ESMTPS id 5A134133D1;
        Wed,  4 Jan 2023 14:42:55 +0000 (UTC)
Received: from dovecot-director2.suse.de ([192.168.254.65])
        by imap2.suse-dmz.suse.de with ESMTPSA
        id EmlAFW+QtWPWWgAAMHmgww
        (envelope-from <tiwai@suse.de>); Wed, 04 Jan 2023 14:42:55 +0000
Date:   Wed, 04 Jan 2023 15:42:54 +0100
Message-ID: <87zgaymkcx.wl-tiwai@suse.de>
From:   Takashi Iwai <tiwai@suse.de>
To:     Michael Ralston <michael@ralston.id.au>
Cc:     Thorsten Leemhuis <regressions@leemhuis.info>,
        alsa-devel@alsa-project.org, regressions@lists.linux.dev,
        stable@vger.kernel.org, Jaroslav Kysela <perex@perex.cz>,
        Takashi Iwai <tiwai@suse.com>
Subject: Re: USB-Audio regression on behringer UMC404HD
In-Reply-To: <CAC2975LFWnK6f05j5my4=ebmhS0bVhigz8VH6cbaUtVT+ADxbA@mail.gmail.com>
References: <CAC2975JXkS1A5Tj9b02G_sy25ZWN-ys+tc9wmkoS=qPgKCogSg@mail.gmail.com>
        <bf646395-1231-92f6-7c5a-5b7765596358@leemhuis.info>
        <87zgb0q7x4.wl-tiwai@suse.de>
        <CAC2975K24Gt3rGieAToHjb7FEHv84aqiRSQx7EOuR2Q7KByUXw@mail.gmail.com>
        <87sfgrrb5f.wl-tiwai@suse.de>
        <CAC2975+cUqiFC0LO-D-fi0swH+x=_FMuG+==mhg6HH4pc_YDRA@mail.gmail.com>
        <87bknfr6rd.wl-tiwai@suse.de>
        <CAC2975+CP0WKmXouX_8TffT1+VpU3EuOzyGHMv+VsAOBjCyhnA@mail.gmail.com>
        <878rijr6dz.wl-tiwai@suse.de>
        <CAC2975+Ybz2-jyJAwAUEu5S1XKfp0B-p4s-gAsMPfZdD61uNfQ@mail.gmail.com>
        <87zgazppuc.wl-tiwai@suse.de>
        <CAC2975+476CHDL3YM=uExHu96UB2rodAng9PVYHX+vGnSCppGA@mail.gmail.com>
        <CAC2975Ja-o6-qCWv2bUkt3ps7BcKvb96rao_De4SGVW1v8uE=A@mail.gmail.com>
        <CAC2975KFqvTitbJHJZ6a4Tuxsq=nPGvW3vjAAtkQxw=sBgeDqw@mail.gmail.com>
        <CAC2975Jw63j26DhvDjiLc7dXwaRz=eK0aWNuErQ8dkEn_Gemjg@mail.gmail.com>
        <87ilhmpvdt.wl-tiwai@suse.de>
        <CAC2975LFWnK6f05j5my4=ebmhS0bVhigz8VH6cbaUtVT+ADxbA@mail.gmail.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) Emacs/27.2 Mule/6.0
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
X-Spam-Status: No, score=-4.4 required=5.0 tests=BAYES_00,DKIM_SIGNED,
        DKIM_VALID,DKIM_VALID_AU,DKIM_VALID_EF,RCVD_IN_DNSWL_MED,SPF_HELO_NONE,
        SPF_PASS autolearn=ham autolearn_force=no version=3.4.6
X-Spam-Checker-Version: SpamAssassin 3.4.6 (2021-04-09) on
        lindbergh.monkeyblade.net
Precedence: bulk
List-ID: <stable.vger.kernel.org>
X-Mailing-List: stable@vger.kernel.org

On Wed, 04 Jan 2023 15:22:13 +0100,
Michael Ralston wrote:
> 
> On Wed, 4 Jan 2023 at 19:16, Takashi Iwai <tiwai@suse.de> wrote:
> >
> > I believe it's time to check which commit broke things.
> > Assume that the bug is USB audio core changes, the following 8 commits
> > are relevant:
> >
> 
> Reverting 1045f5f1ff0751423aeb65648e5e1abd7a7a8672 resulted in this
> compiler error:
> 
> sound/usb/endpoint.c: In function 'snd_usb_endpoint_stop':
> sound/usb/endpoint.c:1672:27: error: 'struct snd_usb_endpoint' has no
> member named 'need_prepare'
> 1672 |                         ep->need_prepare = true;
>      |                           ^~
> 
> I did git annotate on endpoint.c and found line 1672 was added by commit:
> 3759ae6600e40
> 
> Reverting this commit has allowed me to compile a kernel again.
> 
> 3759ae6600e40
> 1045f5f1ff0751423aeb65648e5e1abd7a7a8672
> 9355b60e401d825590d37f04ea873c58efe9b7bf
> a74f8d0aa902ca494676b79226e0b5a1747b81d4
> 9902b303b5ade208b58f0dd38a09831813582211
> 9a737e7f8b371e97eb649904276407cee2c9cf30
> 
> I reverted these six commits, testing each one independently, then
> adding the next on top of the others, and it didn't fix the issue.
> Then the next commit wouldn't revert cleanly.
> 
> CONFLICT (content): Merge conflict in sound/usb/pcm.c
> error: could not revert 2be79d586454... ALSA: usb-audio: Split
> endpoint setups for hw_params and prepare (take#2)
> 
> ++<<<<<<< HEAD
> + again:
> +      if (subs->sync_endpoint) {
> +              ret = snd_usb_endpoint_prepare(chip, subs->sync_endpoint);
> +              if (ret < 0)
> +                      goto unlock;
> +      }
> +
> +      ret = snd_usb_endpoint_prepare(chip, subs->data_endpoint);
> ++=======
> +       ret = configure_endpoints(chip, subs);
> ++>>>>>>> parent of 2be79d586454 (ALSA: usb-audio: Split endpoint
> setups for hw_params and prepare (take#2))
>        if (ret < 0)
>                goto unlock;
> -       else if (ret > 0)
> -               snd_usb_set_format_quirk(subs, subs->cur_audiofmt);
> -       ret = 0;
> 
> 
> Again, I did a git annotate and found I needed to also revert
> 67fd112b4b040 to get 2be79d58645465351af5320eb14c70a94724c5ef to
> revert.
> 
> This one also didn't fix the issue.
> 
> ac5e2fb425e1121ceef2b9d1b3ffccc195d55707
> This final revert on top of all the others fixed the issue.
> 
> These are the reverts I made:
> 3759ae6600e40
> 1045f5f1ff0751423aeb65648e5e1abd7a7a8672
> 9355b60e401d825590d37f04ea873c58efe9b7bf
> a74f8d0aa902ca494676b79226e0b5a1747b81d4
> 9902b303b5ade208b58f0dd38a09831813582211
> 9a737e7f8b371e97eb649904276407cee2c9cf30
> 67fd112b4b040
> 2be79d58645465351af5320eb14c70a94724c5ef
> ac5e2fb425e1121ceef2b9d1b3ffccc195d55707

Oh, did you test with 6.2-rc?  I checked the reverts only on top of
the 6.1.0.  From there, you can revert all mentioned commits cleanly
and should build.

In anyway, do I understand correctly that the bug still persists at
the revert of the commit 2be79d58645465351af5320eb14c70a94724c5ef, and
it's fixed by the revert of ac5e2fb425e1121ceef2b9d1b3ffccc195d55707?

If so, what happens if you revert only
ac5e2fb425e1121ceef2b9d1b3ffccc195d55707?


Takashi
