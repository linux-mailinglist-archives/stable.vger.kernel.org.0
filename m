Return-Path: <stable-owner@vger.kernel.org>
X-Original-To: lists+stable@lfdr.de
Delivered-To: lists+stable@lfdr.de
Received: from out1.vger.email (out1.vger.email [IPv6:2620:137:e000::1:20])
	by mail.lfdr.de (Postfix) with ESMTP id 2428A4ED1A9
	for <lists+stable@lfdr.de>; Thu, 31 Mar 2022 04:25:11 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229792AbiCaC0k (ORCPT <rfc822;lists+stable@lfdr.de>);
        Wed, 30 Mar 2022 22:26:40 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:55090 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S235361AbiCaC0f (ORCPT
        <rfc822;stable@vger.kernel.org>); Wed, 30 Mar 2022 22:26:35 -0400
Received: from mout.gmx.net (mout.gmx.net [212.227.17.20])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 82F9D6C1C5
        for <stable@vger.kernel.org>; Wed, 30 Mar 2022 19:24:48 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=gmx.net;
        s=badeba3b8450; t=1648693477;
        bh=A4mW7hbO1OgipmdF60UOt3QtBOdVvxA8M/4k4Kt+Z2s=;
        h=X-UI-Sender-Class:From:To:Cc:Subject:Date;
        b=g9Bk+UH97kAIhf8GO4bfuOEJpunkBQ3obCWrj/4btKNhEwFQnxJwzhLFhNz7DoYCQ
         PbW5ZmL7s+dCopfLtpAhFn4woxyYyEgxy1Ig0YaW/nQHZwJVWORRklczJSK+4c5gDL
         HOf9ccmOOgUqh2l4HGh+qKEI8A0M0ytPB4RIrom4=
X-UI-Sender-Class: 01bb95c1-4bf8-414a-932a-4f6e2808ef9c
Received: from Venus.fritz.box ([46.223.2.105]) by mail.gmx.net (mrgmx105
 [212.227.17.168]) with ESMTPSA (Nemesis) id 1MMXQF-1nHOvC3B4x-00JZSd; Thu, 31
 Mar 2022 04:24:37 +0200
From:   Lino Sanfilippo <LinoSanfilippo@gmx.de>
To:     gregkh@linuxfoundation.org
Cc:     LinoSanfilippo@gmx.de, jarkko@kernel.org, jgg@nvidia.com,
        jgg@ziepe.ca, stable@vger.kernel.org, stefanb@linux.ibm.com
Subject: [PATCH for-4.14] tpm: fix reference counting for struct tpm_chip
Date:   Thu, 31 Mar 2022 04:24:30 +0200
Message-Id: <20220331022430.1937-1-LinoSanfilippo@gmx.de>
X-Mailer: git-send-email 2.35.1
MIME-Version: 1.0
Content-Transfer-Encoding: base64
X-Provags-ID: V03:K1:xmNipvPS/1P76cgcryv7PmIapJQWKixwUpQWtO+Bvejp+jRrWrS
 66oUF/bE5IEx7Xl17CDqGPXUL2nyy7DI3dP+rBpNbtEfefs5TnUydmAWcyEbnWxZXtrO0rA
 X09ly+58L3ZQLKp7d+3hzF07+gIRaZJ7cEHrsB+/aqZDIqqBdQOp+i6Qy7RvjedZeHXIiDK
 eOvUxNwdfUWbk5QPxvQAw==
X-UI-Out-Filterresults: notjunk:1;V03:K0:zWVCuizJ1os=:s8NjTBMgYocZlVsXFbPpUz
 9OkR17tSuQwKP/Cw7SeK6rHJPplk7nwMJHC+3O9+hpJ2PMLXDbqJNnKAgFaJhRHv/jZlnLXll
 zWvSIyICZk7UixDJIzEw5Kz7h9a4pG50LEud3tpLSm+sQoJCurft32pea+pJmq8vX5fvFTna+
 npwhB0Fdjr5AQ4NbZTiOujeVdEvZyVsgFRdgvoSJD4mRj31OuXRz98izxAjCEAfY9IcmVDS+8
 3M9RFi1wzzKrdBfNJYjLp49inw0zhAvVQCwjtKS0TTxU5JdPs6HmQR6wAw8nUe6zhMPWjD9ha
 nTk+zeI3FP4UfpebPIwwrGJBgYXuTC6GNiT8ynhmUT9gkmul91wMS1SKB+gOnwrrtr2PR3+r8
 Cnm7keRKtNRTUx4Tx+a5ezmZiGHoueEaIQ/3EbpOfczDpnHtbDpvWLec9vbbM5aI42FOIFz6Y
 NEOx8EJ31fXQSEfveORm65kWib6ZH/dnh8J7IDAkpYRbwvBugB4s9Ov9zc4/QftEIohoYa01S
 ByCJULZjo9msOdGtkECqaTiC/YzM8ePM0XUPfh7o91HPg9dARIxI9PcUskMQTrcajjgBAEKRK
 W0r9PPwFo1c07DdD/2PSHEsg2sYcybn4u/VZnr7NuEkE6UocFhNnEBvJXIgiJwMxjHGUbRkMq
 v9Pe91oWF/xfkeeG+6vvzJ5F7Eg5TEJ787CllzGf6tR/UH+wnPFiKCfQsIHjIH12jJtuiO0wQ
 VcamE4N8wxf1GoXSK5rwjaJRnWyyIKkdzEVsDhQCXkYIeE3E0En5Ii8xIE/no3LeZr8ncW8qp
 KWk9qVvOiE2a0pvm6QZx32e7rdY9xtyNVQzvp1cBgBIKEdhtOT6e2avGBMETaabl9EbXjUDYX
 A0f9MVNi4GDzt4+15JoNKctClbRNIrZWoB3K1ecV/wnhNv4UkSmYHMy/OJa6FDMv8z/1siCAQ
 S2zN/mPMmLTslp3GYZh3y0mFOt34o7wwZ+QtGTKNye+MVUZMImIjAh8Ey3hGpLQ76nUNZE8fh
 IZQDiaaCe/kKYP8MhygtTUiLNBYCfLqSKNE/wfVOq1Hk4H4qYUeN+ZcQX4UlzsHzJDRJkWQop
 6bJbH/jRfBSoxsT+QyT1ZxmCBiwPbpfgGQi
X-Spam-Status: No, score=2.5 required=5.0 tests=BAYES_00,DKIM_SIGNED,
        DKIM_VALID,FREEMAIL_FROM,MIME_BASE64_TEXT,RCVD_IN_DNSWL_LOW,
        RCVD_IN_MSPIKE_H2,RCVD_IN_SBL_CSS,SPF_HELO_NONE,SPF_PASS,
        T_SCC_BODY_TEXT_LINE autolearn=no autolearn_force=no version=3.4.6
X-Spam-Level: **
X-Spam-Checker-Version: SpamAssassin 3.4.6 (2021-04-09) on
        lindbergh.monkeyblade.net
Precedence: bulk
List-ID: <stable.vger.kernel.org>
X-Mailing-List: stable@vger.kernel.org

Y29tbWl0IDdlMDQzOGY4M2RjNzY5NDY1ZWU2NjNiYjVkY2Y4Y2MxNTQ5NDA3MTIgdXBzdHJlYW0u
CgpUaGUgZm9sbG93aW5nIHNlcXVlbmNlIG9mIG9wZXJhdGlvbnMgcmVzdWx0cyBpbiBhIHJlZmNv
dW50IHdhcm5pbmc6CgoxLiBPcGVuIGRldmljZSAvZGV2L3RwbXJtLgoyLiBSZW1vdmUgbW9kdWxl
IHRwbV90aXNfc3BpLgozLiBXcml0ZSBhIFRQTSBjb21tYW5kIHRvIHRoZSBmaWxlIGRlc2NyaXB0
b3Igb3BlbmVkIGF0IHN0ZXAgMS4KCi0tLS0tLS0tLS0tLVsgY3V0IGhlcmUgXS0tLS0tLS0tLS0t
LQpXQVJOSU5HOiBDUFU6IDMgUElEOiAxMTYxIGF0IGxpYi9yZWZjb3VudC5jOjI1IGtvYmplY3Rf
Z2V0KzB4YTAvMHhhNApyZWZjb3VudF90OiBhZGRpdGlvbiBvbiAwOyB1c2UtYWZ0ZXItZnJlZS4K
TW9kdWxlcyBsaW5rZWQgaW46IHRwbV90aXNfc3BpIHRwbV90aXNfY29yZSB0cG0gbWRpb19iY21f
dW5pbWFjIGJyY21mbWFjCnNoYTI1Nl9nZW5lcmljIGxpYnNoYTI1NiBzaGEyNTZfYXJtIGhjaV91
YXJ0IGJ0YmNtIGJsdWV0b290aCBjZmc4MDIxMSB2YzQKYnJjbXV0aWwgZWNkaF9nZW5lcmljIGVj
YyBzbmRfc29jX2NvcmUgY3JjMzJfYXJtX2NlIGxpYmFlcwpyYXNwYmVycnlwaV9od21vbiBhYzk3
X2J1cyBzbmRfcGNtX2RtYWVuZ2luZSBiY20yNzExX3RoZXJtYWwgc25kX3BjbQpzbmRfdGltZXIg
Z2VuZXQgc25kIHBoeV9nZW5lcmljIHNvdW5kY29yZSBbbGFzdCB1bmxvYWRlZDogc3BpX2JjbTI4
MzVdCkNQVTogMyBQSUQ6IDExNjEgQ29tbTogaG9sZF9vcGVuIE5vdCB0YWludGVkIDUuMTAuMGxz
LW1haW4tZGlydHkgIzIKSGFyZHdhcmUgbmFtZTogQkNNMjcxMQpbPGMwNDEwYzNjPl0gKHVud2lu
ZF9iYWNrdHJhY2UpIGZyb20gWzxjMDQwYjU4MD5dIChzaG93X3N0YWNrKzB4MTAvMHgxNCkKWzxj
MDQwYjU4MD5dIChzaG93X3N0YWNrKSBmcm9tIFs8YzEwOTIxNzQ+XSAoZHVtcF9zdGFjaysweGM0
LzB4ZDgpCls8YzEwOTIxNzQ+XSAoZHVtcF9zdGFjaykgZnJvbSBbPGMwNDQ1YTMwPl0gKF9fd2Fy
bisweDEwNC8weDEwOCkKWzxjMDQ0NWEzMD5dIChfX3dhcm4pIGZyb20gWzxjMDQ0NWFhOD5dICh3
YXJuX3Nsb3dwYXRoX2ZtdCsweDc0LzB4YjgpCls8YzA0NDVhYTg+XSAod2Fybl9zbG93cGF0aF9m
bXQpIGZyb20gWzxjMDg0MzVkMD5dIChrb2JqZWN0X2dldCsweGEwLzB4YTQpCls8YzA4NDM1ZDA+
XSAoa29iamVjdF9nZXQpIGZyb20gWzxiZjBhNzE1Yz5dICh0cG1fdHJ5X2dldF9vcHMrMHgxNC8w
eDU0IFt0cG1dKQpbPGJmMGE3MTVjPl0gKHRwbV90cnlfZ2V0X29wcyBbdHBtXSkgZnJvbSBbPGJm
MGE3ZDZjPl0gKHRwbV9jb21tb25fd3JpdGUrMHgzOC8weDYwIFt0cG1dKQpbPGJmMGE3ZDZjPl0g
KHRwbV9jb21tb25fd3JpdGUgW3RwbV0pIGZyb20gWzxjMDVhN2FjMD5dICh2ZnNfd3JpdGUrMHhj
NC8weDNjMCkKWzxjMDVhN2FjMD5dICh2ZnNfd3JpdGUpIGZyb20gWzxjMDVhN2VlND5dIChrc3lz
X3dyaXRlKzB4NTgvMHhjYykKWzxjMDVhN2VlND5dIChrc3lzX3dyaXRlKSBmcm9tIFs8YzA0MDAx
YTA+XSAocmV0X2Zhc3Rfc3lzY2FsbCsweDAvMHg0YykKRXhjZXB0aW9uIHN0YWNrKDB4YzIyNmJm
YTggdG8gMHhjMjI2YmZmMCkKYmZhMDogICAgICAgICAgICAgICAgICAgMDAwMDAwMDAgMDAwMTA1
YjQgMDAwMDAwMDMgYmVhZmU2NjQgMDAwMDAwMTQgMDAwMDAwMDAKYmZjMDogMDAwMDAwMDAgMDAw
MTA1YjQgMDAwMTAzZjggMDAwMDAwMDQgMDAwMDAwMDAgMDAwMDAwMDAgYjZmOWMwMDAgYmVhZmU2
ODQKYmZlMDogMDAwMDAwNmMgYmVhZmU2NDggMDAwMTA1NmMgYjZlYjY5NDQKLS0tWyBlbmQgdHJh
Y2UgZDRiODQwOWRlZjliOGIxZiBdLS0tCgpUaGUgcmVhc29uIGZvciB0aGlzIHdhcm5pbmcgaXMg
dGhlIGF0dGVtcHQgdG8gZ2V0IHRoZSBjaGlwLT5kZXYgcmVmZXJlbmNlCmluIHRwbV9jb21tb25f
d3JpdGUoKSBhbHRob3VnaCB0aGUgcmVmZXJlbmNlIGNvdW50ZXIgaXMgYWxyZWFkeSB6ZXJvLgoK
U2luY2UgY29tbWl0IDg5NzliMDJhYWYxZCAoInRwbTogRml4IHJlZmVyZW5jZSBjb3VudCB0byBt
YWluIGRldmljZSIpIHRoZQpleHRyYSByZWZlcmVuY2UgdXNlZCB0byBwcmV2ZW50IGEgcHJlbWF0
dXJlIHplcm8gY291bnRlciBpcyBuZXZlciB0YWtlbiwKYmVjYXVzZSB0aGUgcmVxdWlyZWQgVFBN
X0NISVBfRkxBR19UUE0yIGZsYWcgaXMgbmV2ZXIgc2V0LgoKRml4IHRoaXMgYnkgbW92aW5nIHRo
ZSBUUE0gMiBjaGFyYWN0ZXIgZGV2aWNlIGhhbmRsaW5nIGZyb20KdHBtX2NoaXBfYWxsb2MoKSB0
byB0cG1fYWRkX2NoYXJfZGV2aWNlKCkgd2hpY2ggaXMgY2FsbGVkIGF0IGEgbGF0ZXIgcG9pbnQK
aW4gdGltZSB3aGVuIHRoZSBmbGFnIGhhcyBiZWVuIHNldCBpbiBjYXNlIG9mIFRQTTIuCgpDb21t
aXQgZmRjOTE1ZjdmNzE5ICgidHBtOiBleHBvc2Ugc3BhY2VzIHZpYSBhIGRldmljZSBsaW5rIC9k
ZXYvdHBtcm08bj4iKQphbHJlYWR5IGludHJvZHVjZWQgZnVuY3Rpb24gdHBtX2RldnNfcmVsZWFz
ZSgpIHRvIHJlbGVhc2UgdGhlIGV4dHJhCnJlZmVyZW5jZSBidXQgZGlkIG5vdCBpbXBsZW1lbnQg
dGhlIHJlcXVpcmVkIHB1dCBvbiBjaGlwLT5kZXZzIHRoYXQgcmVzdWx0cwppbiB0aGUgY2FsbCBv
ZiB0aGlzIGZ1bmN0aW9uLgoKRml4IHRoaXMgYnkgcHV0dGluZyBjaGlwLT5kZXZzIGluIHRwbV9j
aGlwX3VucmVnaXN0ZXIoKS4KCkZpbmFsbHkgbW92ZSB0aGUgbmV3IGltcGxlbWVudGF0aW9uIGZv
ciB0aGUgVFBNIDIgaGFuZGxpbmcgaW50byBhIG5ldwpmdW5jdGlvbiB0byBhdm9pZCBtdWx0aXBs
ZSBjaGVja3MgZm9yIHRoZSBUUE1fQ0hJUF9GTEFHX1RQTTIgZmxhZyBpbiB0aGUKZ29vZCBjYXNl
IGFuZCBlcnJvciBjYXNlcy4KCkNjOiBzdGFibGVAdmdlci5rZXJuZWwub3JnCkZpeGVzOiBmZGM5
MTVmN2Y3MTkgKCJ0cG06IGV4cG9zZSBzcGFjZXMgdmlhIGEgZGV2aWNlIGxpbmsgL2Rldi90cG1y
bTxuPiIpCkZpeGVzOiA4OTc5YjAyYWFmMWQgKCJ0cG06IEZpeCByZWZlcmVuY2UgY291bnQgdG8g
bWFpbiBkZXZpY2UiKQpDby1kZXZlbG9wZWQtYnk6IEphc29uIEd1bnRob3JwZSA8amdnQHppZXBl
LmNhPgpTaWduZWQtb2ZmLWJ5OiBKYXNvbiBHdW50aG9ycGUgPGpnZ0B6aWVwZS5jYT4KU2lnbmVk
LW9mZi1ieTogTGlubyBTYW5maWxpcHBvIDxMaW5vU2FuZmlsaXBwb0BnbXguZGU+ClRlc3RlZC1i
eTogU3RlZmFuIEJlcmdlciA8c3RlZmFuYkBsaW51eC5pYm0uY29tPgpSZXZpZXdlZC1ieTogSmFz
b24gR3VudGhvcnBlIDxqZ2dAbnZpZGlhLmNvbT4KUmV2aWV3ZWQtYnk6IEphcmtrbyBTYWtraW5l
biA8amFya2tvQGtlcm5lbC5vcmc+ClNpZ25lZC1vZmYtYnk6IEphcmtrbyBTYWtraW5lbiA8amFy
a2tvQGtlcm5lbC5vcmc+Ci0tLQogZHJpdmVycy9jaGFyL3RwbS90cG0tY2hpcC5jICAgfCA0NiAr
KysrKy0tLS0tLS0tLS0tLS0tLS0tLS0tCiBkcml2ZXJzL2NoYXIvdHBtL3RwbS5oICAgICAgICB8
ICAyICsrCiBkcml2ZXJzL2NoYXIvdHBtL3RwbTItc3BhY2UuYyB8IDY1ICsrKysrKysrKysrKysr
KysrKysrKysrKysrKysrKysrKysrCiAzIGZpbGVzIGNoYW5nZWQsIDc1IGluc2VydGlvbnMoKyks
IDM4IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvY2hhci90cG0vdHBtLWNoaXAu
YyBiL2RyaXZlcnMvY2hhci90cG0vdHBtLWNoaXAuYwppbmRleCAxMWVjNWMyNzE1YTkuLmQ5MWE3
OTVhZDQzMiAxMDA2NDQKLS0tIGEvZHJpdmVycy9jaGFyL3RwbS90cG0tY2hpcC5jCisrKyBiL2Ry
aXZlcnMvY2hhci90cG0vdHBtLWNoaXAuYwpAQCAtMTM0LDE0ICsxMzQsNiBAQCBzdGF0aWMgdm9p
ZCB0cG1fZGV2X3JlbGVhc2Uoc3RydWN0IGRldmljZSAqZGV2KQogCWtmcmVlKGNoaXApOwogfQog
Ci1zdGF0aWMgdm9pZCB0cG1fZGV2c19yZWxlYXNlKHN0cnVjdCBkZXZpY2UgKmRldikKLXsKLQlz
dHJ1Y3QgdHBtX2NoaXAgKmNoaXAgPSBjb250YWluZXJfb2YoZGV2LCBzdHJ1Y3QgdHBtX2NoaXAs
IGRldnMpOwotCi0JLyogcmVsZWFzZSB0aGUgbWFzdGVyIGRldmljZSByZWZlcmVuY2UgKi8KLQlw
dXRfZGV2aWNlKCZjaGlwLT5kZXYpOwotfQotCiAvKioKICAqIHRwbV9jbGFzc19zaHV0ZG93bigp
IC0gcHJlcGFyZSB0aGUgVFBNIGRldmljZSBmb3IgbG9zcyBvZiBwb3dlci4KICAqIEBkZXY6IGRl
dmljZSB0byB3aGljaCB0aGUgY2hpcCBpcyBhc3NvY2lhdGVkLgpAQCAtMjA1LDcgKzE5Nyw2IEBA
IHN0cnVjdCB0cG1fY2hpcCAqdHBtX2NoaXBfYWxsb2Moc3RydWN0IGRldmljZSAqcGRldiwKIAlj
aGlwLT5kZXZfbnVtID0gcmM7CiAKIAlkZXZpY2VfaW5pdGlhbGl6ZSgmY2hpcC0+ZGV2KTsKLQlk
ZXZpY2VfaW5pdGlhbGl6ZSgmY2hpcC0+ZGV2cyk7CiAKIAljaGlwLT5kZXYuY2xhc3MgPSB0cG1f
Y2xhc3M7CiAJY2hpcC0+ZGV2LmNsYXNzLT5zaHV0ZG93bl9wcmUgPSB0cG1fY2xhc3Nfc2h1dGRv
d247CkBAIC0yMTMsMjkgKzIwNCwxMiBAQCBzdHJ1Y3QgdHBtX2NoaXAgKnRwbV9jaGlwX2FsbG9j
KHN0cnVjdCBkZXZpY2UgKnBkZXYsCiAJY2hpcC0+ZGV2LnBhcmVudCA9IHBkZXY7CiAJY2hpcC0+
ZGV2Lmdyb3VwcyA9IGNoaXAtPmdyb3VwczsKIAotCWNoaXAtPmRldnMucGFyZW50ID0gcGRldjsK
LQljaGlwLT5kZXZzLmNsYXNzID0gdHBtcm1fY2xhc3M7Ci0JY2hpcC0+ZGV2cy5yZWxlYXNlID0g
dHBtX2RldnNfcmVsZWFzZTsKLQkvKiBnZXQgZXh0cmEgcmVmZXJlbmNlIG9uIG1haW4gZGV2aWNl
IHRvIGhvbGQgb24KLQkgKiBiZWhhbGYgb2YgZGV2cy4gIFRoaXMgaG9sZHMgdGhlIGNoaXAgc3Ry
dWN0dXJlCi0JICogd2hpbGUgY2RldnMgaXMgaW4gdXNlLiAgVGhlIGNvcnJlc3BvbmRpbmcgcHV0
Ci0JICogaXMgaW4gdGhlIHRwbV9kZXZzX3JlbGVhc2UgKFRQTTIgb25seSkKLQkgKi8KLQlpZiAo
Y2hpcC0+ZmxhZ3MgJiBUUE1fQ0hJUF9GTEFHX1RQTTIpCi0JCWdldF9kZXZpY2UoJmNoaXAtPmRl
dik7Ci0KIAlpZiAoY2hpcC0+ZGV2X251bSA9PSAwKQogCQljaGlwLT5kZXYuZGV2dCA9IE1LREVW
KE1JU0NfTUFKT1IsIFRQTV9NSU5PUik7CiAJZWxzZQogCQljaGlwLT5kZXYuZGV2dCA9IE1LREVW
KE1BSk9SKHRwbV9kZXZ0KSwgY2hpcC0+ZGV2X251bSk7CiAKLQljaGlwLT5kZXZzLmRldnQgPQot
CQlNS0RFVihNQUpPUih0cG1fZGV2dCksIGNoaXAtPmRldl9udW0gKyBUUE1fTlVNX0RFVklDRVMp
OwotCiAJcmMgPSBkZXZfc2V0X25hbWUoJmNoaXAtPmRldiwgInRwbSVkIiwgY2hpcC0+ZGV2X251
bSk7Ci0JaWYgKHJjKQotCQlnb3RvIG91dDsKLQlyYyA9IGRldl9zZXRfbmFtZSgmY2hpcC0+ZGV2
cywgInRwbXJtJWQiLCBjaGlwLT5kZXZfbnVtKTsKIAlpZiAocmMpCiAJCWdvdG8gb3V0OwogCkBA
IC0yNDMsOSArMjE3LDcgQEAgc3RydWN0IHRwbV9jaGlwICp0cG1fY2hpcF9hbGxvYyhzdHJ1Y3Qg
ZGV2aWNlICpwZGV2LAogCQljaGlwLT5mbGFncyB8PSBUUE1fQ0hJUF9GTEFHX1ZJUlRVQUw7CiAK
IAljZGV2X2luaXQoJmNoaXAtPmNkZXYsICZ0cG1fZm9wcyk7Ci0JY2Rldl9pbml0KCZjaGlwLT5j
ZGV2cywgJnRwbXJtX2ZvcHMpOwogCWNoaXAtPmNkZXYub3duZXIgPSBUSElTX01PRFVMRTsKLQlj
aGlwLT5jZGV2cy5vd25lciA9IFRISVNfTU9EVUxFOwogCiAJcmMgPSB0cG0yX2luaXRfc3BhY2Uo
JmNoaXAtPndvcmtfc3BhY2UsIFRQTTJfU1BBQ0VfQlVGRkVSX1NJWkUpOwogCWlmIChyYykgewpA
QCAtMjU3LDcgKzIyOSw2IEBAIHN0cnVjdCB0cG1fY2hpcCAqdHBtX2NoaXBfYWxsb2Moc3RydWN0
IGRldmljZSAqcGRldiwKIAlyZXR1cm4gY2hpcDsKIAogb3V0OgotCXB1dF9kZXZpY2UoJmNoaXAt
PmRldnMpOwogCXB1dF9kZXZpY2UoJmNoaXAtPmRldik7CiAJcmV0dXJuIEVSUl9QVFIocmMpOwog
fQpAQCAtMzA2LDE0ICsyNzcsOSBAQCBzdGF0aWMgaW50IHRwbV9hZGRfY2hhcl9kZXZpY2Uoc3Ry
dWN0IHRwbV9jaGlwICpjaGlwKQogCX0KIAogCWlmIChjaGlwLT5mbGFncyAmIFRQTV9DSElQX0ZM
QUdfVFBNMikgewotCQlyYyA9IGNkZXZfZGV2aWNlX2FkZCgmY2hpcC0+Y2RldnMsICZjaGlwLT5k
ZXZzKTsKLQkJaWYgKHJjKSB7Ci0JCQlkZXZfZXJyKCZjaGlwLT5kZXZzLAotCQkJCSJ1bmFibGUg
dG8gY2Rldl9kZXZpY2VfYWRkKCkgJXMsIG1ham9yICVkLCBtaW5vciAlZCwgZXJyPSVkXG4iLAot
CQkJCWRldl9uYW1lKCZjaGlwLT5kZXZzKSwgTUFKT1IoY2hpcC0+ZGV2cy5kZXZ0KSwKLQkJCQlN
SU5PUihjaGlwLT5kZXZzLmRldnQpLCByYyk7Ci0JCQlyZXR1cm4gcmM7Ci0JCX0KKwkJcmMgPSB0
cG1fZGV2c19hZGQoY2hpcCk7CisJCWlmIChyYykKKwkJCWdvdG8gZXJyX2RlbF9jZGV2OwogCX0K
IAogCS8qIE1ha2UgdGhlIGNoaXAgYXZhaWxhYmxlLiAqLwpAQCAtMzIxLDYgKzI4NywxMCBAQCBz
dGF0aWMgaW50IHRwbV9hZGRfY2hhcl9kZXZpY2Uoc3RydWN0IHRwbV9jaGlwICpjaGlwKQogCWlk
cl9yZXBsYWNlKCZkZXZfbnVtc19pZHIsIGNoaXAsIGNoaXAtPmRldl9udW0pOwogCW11dGV4X3Vu
bG9jaygmaWRyX2xvY2spOwogCisJcmV0dXJuIDA7CisKK2Vycl9kZWxfY2RldjoKKwljZGV2X2Rl
dmljZV9kZWwoJmNoaXAtPmNkZXYsICZjaGlwLT5kZXYpOwogCXJldHVybiByYzsKIH0KIApAQCAt
NDQ5LDcgKzQxOSw3IEBAIHZvaWQgdHBtX2NoaXBfdW5yZWdpc3RlcihzdHJ1Y3QgdHBtX2NoaXAg
KmNoaXApCiAJdHBtX2RlbF9sZWdhY3lfc3lzZnMoY2hpcCk7CiAJdHBtX2Jpb3NfbG9nX3RlYXJk
b3duKGNoaXApOwogCWlmIChjaGlwLT5mbGFncyAmIFRQTV9DSElQX0ZMQUdfVFBNMikKLQkJY2Rl
dl9kZXZpY2VfZGVsKCZjaGlwLT5jZGV2cywgJmNoaXAtPmRldnMpOworCQl0cG1fZGV2c19yZW1v
dmUoY2hpcCk7CiAJdHBtX2RlbF9jaGFyX2RldmljZShjaGlwKTsKIH0KIEVYUE9SVF9TWU1CT0xf
R1BMKHRwbV9jaGlwX3VucmVnaXN0ZXIpOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9jaGFyL3RwbS90
cG0uaCBiL2RyaXZlcnMvY2hhci90cG0vdHBtLmgKaW5kZXggMDE5ZmU4MGZlZGQ4Li43NDM2ZGEw
NDMwNDAgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvY2hhci90cG0vdHBtLmgKKysrIGIvZHJpdmVycy9j
aGFyL3RwbS90cG0uaApAQCAtNTkzLDQgKzU5Myw2IEBAIGludCB0cG0yX3ByZXBhcmVfc3BhY2Uo
c3RydWN0IHRwbV9jaGlwICpjaGlwLCBzdHJ1Y3QgdHBtX3NwYWNlICpzcGFjZSwgdTMyIGNjLAog
CQkgICAgICAgdTggKmNtZCk7CiBpbnQgdHBtMl9jb21taXRfc3BhY2Uoc3RydWN0IHRwbV9jaGlw
ICpjaGlwLCBzdHJ1Y3QgdHBtX3NwYWNlICpzcGFjZSwKIAkJICAgICAgdTMyIGNjLCB1OCAqYnVm
LCBzaXplX3QgKmJ1ZnNpeik7CitpbnQgdHBtX2RldnNfYWRkKHN0cnVjdCB0cG1fY2hpcCAqY2hp
cCk7Cit2b2lkIHRwbV9kZXZzX3JlbW92ZShzdHJ1Y3QgdHBtX2NoaXAgKmNoaXApOwogI2VuZGlm
CmRpZmYgLS1naXQgYS9kcml2ZXJzL2NoYXIvdHBtL3RwbTItc3BhY2UuYyBiL2RyaXZlcnMvY2hh
ci90cG0vdHBtMi1zcGFjZS5jCmluZGV4IGM3NzYzYTk2Y2JhZi4uOGU0MmJjMDk2ZTgzIDEwMDY0
NAotLS0gYS9kcml2ZXJzL2NoYXIvdHBtL3RwbTItc3BhY2UuYworKysgYi9kcml2ZXJzL2NoYXIv
dHBtL3RwbTItc3BhY2UuYwpAQCAtNTQwLDMgKzU0MCw2OCBAQCBpbnQgdHBtMl9jb21taXRfc3Bh
Y2Uoc3RydWN0IHRwbV9jaGlwICpjaGlwLCBzdHJ1Y3QgdHBtX3NwYWNlICpzcGFjZSwKIAogCXJl
dHVybiAwOwogfQorCisvKgorICogUHV0IHRoZSByZWZlcmVuY2UgdG8gdGhlIG1haW4gZGV2aWNl
LgorICovCitzdGF0aWMgdm9pZCB0cG1fZGV2c19yZWxlYXNlKHN0cnVjdCBkZXZpY2UgKmRldikK
K3sKKwlzdHJ1Y3QgdHBtX2NoaXAgKmNoaXAgPSBjb250YWluZXJfb2YoZGV2LCBzdHJ1Y3QgdHBt
X2NoaXAsIGRldnMpOworCisJLyogcmVsZWFzZSB0aGUgbWFzdGVyIGRldmljZSByZWZlcmVuY2Ug
Ki8KKwlwdXRfZGV2aWNlKCZjaGlwLT5kZXYpOworfQorCisvKgorICogUmVtb3ZlIHRoZSBkZXZp
Y2UgZmlsZSBmb3IgZXhwb3NlZCBUUE0gc3BhY2VzIGFuZCByZWxlYXNlIHRoZSBkZXZpY2UKKyAq
IHJlZmVyZW5jZS4gVGhpcyBtYXkgYWxzbyByZWxlYXNlIHRoZSByZWZlcmVuY2UgdG8gdGhlIG1h
c3RlciBkZXZpY2UuCisgKi8KK3ZvaWQgdHBtX2RldnNfcmVtb3ZlKHN0cnVjdCB0cG1fY2hpcCAq
Y2hpcCkKK3sKKwljZGV2X2RldmljZV9kZWwoJmNoaXAtPmNkZXZzLCAmY2hpcC0+ZGV2cyk7CisJ
cHV0X2RldmljZSgmY2hpcC0+ZGV2cyk7Cit9CisKKy8qCisgKiBBZGQgYSBkZXZpY2UgZmlsZSB0
byBleHBvc2UgVFBNIHNwYWNlcy4gQWxzbyB0YWtlIGEgcmVmZXJlbmNlIHRvIHRoZQorICogbWFp
biBkZXZpY2UuCisgKi8KK2ludCB0cG1fZGV2c19hZGQoc3RydWN0IHRwbV9jaGlwICpjaGlwKQor
eworCWludCByYzsKKworCWRldmljZV9pbml0aWFsaXplKCZjaGlwLT5kZXZzKTsKKwljaGlwLT5k
ZXZzLnBhcmVudCA9IGNoaXAtPmRldi5wYXJlbnQ7CisJY2hpcC0+ZGV2cy5jbGFzcyA9IHRwbXJt
X2NsYXNzOworCisJLyoKKwkgKiBHZXQgZXh0cmEgcmVmZXJlbmNlIG9uIG1haW4gZGV2aWNlIHRv
IGhvbGQgb24gYmVoYWxmIG9mIGRldnMuCisJICogVGhpcyBob2xkcyB0aGUgY2hpcCBzdHJ1Y3R1
cmUgd2hpbGUgY2RldnMgaXMgaW4gdXNlLiBUaGUKKwkgKiBjb3JyZXNwb25kaW5nIHB1dCBpcyBp
biB0aGUgdHBtX2RldnNfcmVsZWFzZS4KKwkgKi8KKwlnZXRfZGV2aWNlKCZjaGlwLT5kZXYpOwor
CWNoaXAtPmRldnMucmVsZWFzZSA9IHRwbV9kZXZzX3JlbGVhc2U7CisJY2hpcC0+ZGV2cy5kZXZ0
ID0gTUtERVYoTUFKT1IodHBtX2RldnQpLCBjaGlwLT5kZXZfbnVtICsgVFBNX05VTV9ERVZJQ0VT
KTsKKwljZGV2X2luaXQoJmNoaXAtPmNkZXZzLCAmdHBtcm1fZm9wcyk7CisJY2hpcC0+Y2RldnMu
b3duZXIgPSBUSElTX01PRFVMRTsKKworCXJjID0gZGV2X3NldF9uYW1lKCZjaGlwLT5kZXZzLCAi
dHBtcm0lZCIsIGNoaXAtPmRldl9udW0pOworCWlmIChyYykKKwkJZ290byBlcnJfcHV0X2RldnM7
CisKKwlyYyA9IGNkZXZfZGV2aWNlX2FkZCgmY2hpcC0+Y2RldnMsICZjaGlwLT5kZXZzKTsKKwlp
ZiAocmMpIHsKKwkJZGV2X2VycigmY2hpcC0+ZGV2cywKKwkJCSJ1bmFibGUgdG8gY2Rldl9kZXZp
Y2VfYWRkKCkgJXMsIG1ham9yICVkLCBtaW5vciAlZCwgZXJyPSVkXG4iLAorCQkJZGV2X25hbWUo
JmNoaXAtPmRldnMpLCBNQUpPUihjaGlwLT5kZXZzLmRldnQpLAorCQkJTUlOT1IoY2hpcC0+ZGV2
cy5kZXZ0KSwgcmMpOworCQlnb3RvIGVycl9wdXRfZGV2czsKKwl9CisKKwlyZXR1cm4gMDsKKwor
ZXJyX3B1dF9kZXZzOgorCXB1dF9kZXZpY2UoJmNoaXAtPmRldnMpOworCisJcmV0dXJuIHJjOwor
fQotLSAKMi4zNS4xCgo=
