Return-Path: <stable-owner@vger.kernel.org>
X-Original-To: lists+stable@lfdr.de
Delivered-To: lists+stable@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id 3294A1DBFED
	for <lists+stable@lfdr.de>; Wed, 20 May 2020 22:10:17 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727882AbgETUKQ (ORCPT <rfc822;lists+stable@lfdr.de>);
        Wed, 20 May 2020 16:10:16 -0400
Received: from imap3.hz.codethink.co.uk ([176.9.8.87]:60974 "EHLO
        imap3.hz.codethink.co.uk" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1726853AbgETUKP (ORCPT
        <rfc822;stable@vger.kernel.org>); Wed, 20 May 2020 16:10:15 -0400
Received: from shadbolt.e.decadent.org.uk ([88.96.1.126] helo=xylophone)
        by imap3.hz.codethink.co.uk with esmtpsa  (Exim 4.92 #3 (Debian))
        id 1jbV2Z-00084d-Dn; Wed, 20 May 2020 21:10:11 +0100
Message-ID: <df70afba3439e4573a8e2b61f751577ff67ab36d.camel@codethink.co.uk>
Subject: [4.14-stable] watchdog: Fix the race between the release of
 watchdog_core_data and cdev
From:   Ben Hutchings <ben.hutchings@codethink.co.uk>
To:     Greg Kroah-Hartman <gregkh@linuxfoundation.org>,
        Sasha Levin <Alexander.Levin@microsoft.com>
Cc:     stable <stable@vger.kernel.org>
Date:   Wed, 20 May 2020 21:10:09 +0100
Organization: Codethink Ltd.
Content-Type: multipart/mixed; boundary="=-dJFIrJ7v5edhGV7nkNrW"
User-Agent: Evolution 3.30.5-1.1 
MIME-Version: 1.0
Sender: stable-owner@vger.kernel.org
Precedence: bulk
List-ID: <stable.vger.kernel.org>
X-Mailing-List: stable@vger.kernel.org


--=-dJFIrJ7v5edhGV7nkNrW
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: 7bit

Please queue up the attached backport of commit 2351c88f8296 "watchdog:
Fix the race between the release of watchdog_core_data and cdev" for
4.14.

Ben.

-- 
Ben Hutchings, Software Developer                         Codethink Ltd
https://www.codethink.co.uk/                 Dale House, 35 Dale Street
                                     Manchester, M1 2HF, United Kingdom

--=-dJFIrJ7v5edhGV7nkNrW
Content-Disposition: attachment;
	filename*0=0001-watchdog-Fix-the-race-between-the-release-of-watchdo.pat;
	filename*1=ch
Content-Transfer-Encoding: base64
Content-Type: text/x-patch;
	name="0001-watchdog-Fix-the-race-between-the-release-of-watchdo.patch";
	charset="UTF-8"

RnJvbSAyMzUxYzg4ZjgyOTZlZjk1ZTFjZWRhODE1YzIyOWU1N2FjMzNlYTY0IE1vbiBTZXAgMTcg
MDA6MDA6MDAgMjAwMQpGcm9tOiBLZXZpbiBIYW8gPGhhb2tleGluQGdtYWlsLmNvbT4KRGF0ZTog
VHVlLCA4IE9jdCAyMDE5IDE5OjI5OjM0ICswODAwClN1YmplY3Q6IHdhdGNoZG9nOiBGaXggdGhl
IHJhY2UgYmV0d2VlbiB0aGUgcmVsZWFzZSBvZiB3YXRjaGRvZ19jb3JlX2RhdGEgYW5kCiBjZGV2
Cgpjb21taXQgNzIxMzlkZmEyNDY0ZTQzOTU3ZDMzMDI2Njk5NDc0MGJiN2JlMjUzNSB1cHN0cmVh
bS4KClRoZSBzdHJ1Y3QgY2RldiBpcyBlbWJlZGRlZCBpbiB0aGUgc3RydWN0IHdhdGNoZG9nX2Nv
cmVfZGF0YS4gSW4gdGhlCmN1cnJlbnQgY29kZSwgd2UgbWFuYWdlIHRoZSB3YXRjaGRvZ19jb3Jl
X2RhdGEgd2l0aCBhIGtyZWYsIGJ1dCB0aGUKY2RldiBpcyBtYW5nZWQgYnkgYSBrb2JqZWN0LiBU
aGVyZSBpcyBubyBhbnkgcmVsYXRpb25zaGlwIGJldHdlZW4KdGhpcyBrcmVmIGFuZCBrb2JqZWN0
LiBTbyBpdCBpcyBwb3NzaWJsZSB0aGF0IHRoZSB3YXRjaGRvZ19jb3JlX2RhdGEgaXMKZnJlZWQg
YmVmb3JlIHRoZSBjZGV2IGlzIGVudGlyZWx5IHJlbGVhc2VkLiBXZSBjYW4gZWFzaWx5IGdldCB0
aGUKZm9sbG93aW5nIGNhbGwgdHJhY2Ugd2l0aCBDT05GSUdfREVCVUdfS09CSkVDVF9SRUxFQVNF
IGFuZApDT05GSUdfREVCVUdfT0JKRUNUU19USU1FUlMgZW5hYmxlZC4KICBPREVCVUc6IGZyZWUg
YWN0aXZlIChhY3RpdmUgc3RhdGUgMCkgb2JqZWN0IHR5cGU6IHRpbWVyX2xpc3QgaGludDogZGVs
YXllZF93b3JrX3RpbWVyX2ZuKzB4MC8weDM4CiAgV0FSTklORzogQ1BVOiAyMyBQSUQ6IDEwMjgg
YXQgbGliL2RlYnVnb2JqZWN0cy5jOjQ4MSBkZWJ1Z19wcmludF9vYmplY3QrMHhiMC8weGYwCiAg
TW9kdWxlcyBsaW5rZWQgaW46IHNvZnRkb2coLSkgZGVmbGF0ZSBjdHIgdHdvZmlzaF9nZW5lcmlj
IHR3b2Zpc2hfY29tbW9uIGNhbWVsbGlhX2dlbmVyaWMgc2VycGVudF9nZW5lcmljIGJsb3dmaXNo
X2dlbmVyaWMgYmxvd2Zpc2hfY29tbW9uIGNhc3Q1X2dlbmVyaWMgY2FzdF9jb21tb24gY21hYyB4
Y2JjIGFmX2tleSBzY2hfZnFfY29kZWwgb3BlbnZzd2l0Y2ggbnNoIG5mX2Nvbm5jb3VudCBuZl9u
YXQgbmZfY29ubnRyYWNrIG5mX2RlZnJhZ19pcHY2IG5mX2RlZnJhZ19pcHY0CiAgQ1BVOiAyMyBQ
SUQ6IDEwMjggQ29tbTogbW9kcHJvYmUgTm90IHRhaW50ZWQgNS4zLjAtbmV4dC0yMDE5MDkyNC15
b2N0b2Rldi1zdGFuZGFyZCsgIzE4MAogIEhhcmR3YXJlIG5hbWU6IE1hcnZlbGwgT2N0ZW9uVFgg
Q045NlhYIGJvYXJkIChEVCkKICBwc3RhdGU6IDAwNDAwMDA5IChuemN2IGRhaWYgK1BBTiAtVUFP
KQogIHBjIDogZGVidWdfcHJpbnRfb2JqZWN0KzB4YjAvMHhmMAogIGxyIDogZGVidWdfcHJpbnRf
b2JqZWN0KzB4YjAvMHhmMAogIHNwIDogZmZmZjgwMDAxY2JjZmM3MAogIHgyOTogZmZmZjgwMDAx
Y2JjZmM3MCB4Mjg6IGZmZmY4MDAwMTBlYTIxMjgKICB4Mjc6IGZmZmY4MDAwMTBiYWQwMDAgeDI2
OiAwMDAwMDAwMDAwMDAwMDAwCiAgeDI1OiBmZmZmODAwMDExMDNjNjQwIHgyNDogZmZmZjgwMDAx
MTA3YjI2OAogIHgyMzogZmZmZjgwMDAxMGJhZDllOCB4MjI6IGZmZmY4MDAwMTBlYTIxMjgKICB4
MjE6IGZmZmYwMDBiYzJjNjJhZjggeDIwOiBmZmZmODAwMDExMDNjNjAwCiAgeDE5OiBmZmZmODAw
MDEwZTg2N2Q4IHgxODogMDAwMDAwMDAwMDAwMDA2MAogIHgxNzogMDAwMDAwMDAwMDAwMDAwMCB4
MTY6IDAwMDAwMDAwMDAwMDAwMDAKICB4MTU6IGZmZmYwMDBiZDcyNDA0NzAgeDE0OiA2ZTY5Njgy
MDc0NzM2OTZjCiAgeDEzOiA1ZjcyNjU2ZDY5NzQyMDNhIHgxMjogNjU3MDc5NzQyMDc0NjM2NQog
IHgxMTogNmE2MjZmMjAyOTMwMjA2NSB4MTA6IDc0NjE3NDczMjA2NTc2NjkKICB4OSA6IDc0NjM2
MTI4MjA2NTc2NjkgeDggOiAzMzc4MzAyZjMwNzgzMDJiCiAgeDcgOiAwMDAwMDAwMDAwMDAxZDdh
IHg2IDogZmZmZjgwMDAxMGZkNTg4OQogIHg1IDogMDAwMDAwMDAwMDAwMDAwMCB4NCA6IDAwMDAw
MDAwMDAwMDAwMDAKICB4MyA6IDAwMDAwMDAwMDAwMDAwMDAgeDIgOiBmZmZmMDAwYmZmOTQ4NTQ4
CiAgeDEgOiAyNzZhMWM5ZTFlZGMyMzAwIHgwIDogMDAwMDAwMDAwMDAwMDAwMAogIENhbGwgdHJh
Y2U6CiAgIGRlYnVnX3ByaW50X29iamVjdCsweGIwLzB4ZjAKICAgZGVidWdfY2hlY2tfbm9fb2Jq
X2ZyZWVkKzB4MWU4LzB4MjEwCiAgIGtmcmVlKzB4MWI4LzB4MzY4CiAgIHdhdGNoZG9nX2NkZXZf
dW5yZWdpc3RlcisweDg4LzB4YzgKICAgd2F0Y2hkb2dfZGV2X3VucmVnaXN0ZXIrMHgzOC8weDQ4
CiAgIHdhdGNoZG9nX3VucmVnaXN0ZXJfZGV2aWNlKzB4YTgvMHgxMDAKICAgc29mdGRvZ19leGl0
KzB4MTgvMHhmZWM0IFtzb2Z0ZG9nXQogICBfX2FybTY0X3N5c19kZWxldGVfbW9kdWxlKzB4MTc0
LzB4MjAwCiAgIGVsMF9zdmNfaGFuZGxlcisweGQwLzB4MWM4CiAgIGVsMF9zdmMrMHg4LzB4YwoK
VGhpcyBpcyBhIGNvbW1vbiBpc3N1ZSB3aGVuIHVzaW5nIGNkZXYgZW1iZWRkZWQgaW4gYSBzdHJ1
Y3QuCkZvcnR1bmF0ZWx5LCB3ZSBhbHJlYWR5IGhhdmUgYSBtZWNoYW5pc20gdG8gc29sdmUgdGhp
cyBraW5kIG9mIGlzc3VlLgpQbGVhc2Ugc2VlIGNvbW1pdCAyMzNlZDA5ZDdmZGEgKCJjaGFyZGV2
OiBhZGQgaGVscGVyIGZ1bmN0aW9uIHRvCnJlZ2lzdGVyIGNoYXIgZGV2cyB3aXRoIGEgc3RydWN0
IGRldmljZSIpIGZvciBtb3JlIGRldGFpbC4KCkluIHRoaXMgcGF0Y2gsIHdlIGNob29zZSB0byBl
bWJlZCB0aGUgc3RydWN0IGRldmljZSBpbnRvIHRoZQp3YXRjaGRvZ19jb3JlX2RhdGEsIGFuZCB1
c2UgdGhlIEFQSSBwcm92aWRlZCBieSB0aGUgY29tbWl0IDIzM2VkMDlkN2ZkYQp0byBtYWtlIHN1
cmUgdGhhdCB0aGUgcmVsZWFzZSBvZiB3YXRjaGRvZ19jb3JlX2RhdGEgYW5kIGNkZXYgYXJlCmlu
IHNlcXVlbmNlLgoKU2lnbmVkLW9mZi1ieTogS2V2aW4gSGFvIDxoYW9rZXhpbkBnbWFpbC5jb20+
ClJldmlld2VkLWJ5OiBHdWVudGVyIFJvZWNrIDxsaW51eEByb2Vjay11cy5uZXQ+Ckxpbms6IGh0
dHBzOi8vbG9yZS5rZXJuZWwub3JnL3IvMjAxOTEwMDgxMTI5MzQuMjk2NjktMS1oYW9rZXhpbkBn
bWFpbC5jb20KU2lnbmVkLW9mZi1ieTogR3VlbnRlciBSb2VjayA8bGludXhAcm9lY2stdXMubmV0
PgpTaWduZWQtb2ZmLWJ5OiBXaW0gVmFuIFNlYnJvZWNrIDx3aW1AbGludXgtd2F0Y2hkb2cub3Jn
PgpbYndoOiBCYWNrcG9ydGVkIHRvIDQuMTQ6CiAtIFRoZXJlJ3Mgbm8gcmVib290IG5vdGlmaWVy
IGhlcmUKIC0gQWRqdXN0IGNvbnRleHRdClNpZ25lZC1vZmYtYnk6IEJlbiBIdXRjaGluZ3MgPGJl
bi5odXRjaGluZ3NAY29kZXRoaW5rLmNvLnVrPgotLS0KIGRyaXZlcnMvd2F0Y2hkb2cvd2F0Y2hk
b2dfZGV2LmMgfCA2NyArKysrKysrKysrKysrKystLS0tLS0tLS0tLS0tLS0tLS0KIDEgZmlsZSBj
aGFuZ2VkLCAzMCBpbnNlcnRpb25zKCspLCAzNyBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9k
cml2ZXJzL3dhdGNoZG9nL3dhdGNoZG9nX2Rldi5jIGIvZHJpdmVycy93YXRjaGRvZy93YXRjaGRv
Z19kZXYuYwppbmRleCA1MmUwM2YxYzc2ZTMuLjIxYzNmZmRjOGEwOSAxMDA2NDQKLS0tIGEvZHJp
dmVycy93YXRjaGRvZy93YXRjaGRvZ19kZXYuYworKysgYi9kcml2ZXJzL3dhdGNoZG9nL3dhdGNo
ZG9nX2Rldi5jCkBAIC0zOCw3ICszOCw2IEBACiAjaW5jbHVkZSA8bGludXgvaW5pdC5oPgkJLyog
Rm9yIF9faW5pdC9fX2V4aXQvLi4uICovCiAjaW5jbHVkZSA8bGludXgvamlmZmllcy5oPgkvKiBG
b3IgdGltZW91dCBmdW5jdGlvbnMgKi8KICNpbmNsdWRlIDxsaW51eC9rZXJuZWwuaD4JLyogRm9y
IHByaW50ay9wYW5pYy8uLi4gKi8KLSNpbmNsdWRlIDxsaW51eC9rcmVmLmg+CQkvKiBGb3IgZGF0
YSByZWZlcmVuY2VzICovCiAjaW5jbHVkZSA8bGludXgvbWlzY2RldmljZS5oPgkvKiBGb3IgaGFu
ZGxpbmcgbWlzYyBkZXZpY2VzICovCiAjaW5jbHVkZSA8bGludXgvbW9kdWxlLmg+CS8qIEZvciBt
b2R1bGUgc3R1ZmYvLi4uICovCiAjaW5jbHVkZSA8bGludXgvbXV0ZXguaD4JLyogRm9yIG11dGV4
ZXMgKi8KQEAgLTUzLDE0ICs1MiwxNCBAQAogCiAvKgogICogc3RydWN0IHdhdGNoZG9nX2NvcmVf
ZGF0YSAtIHdhdGNoZG9nIGNvcmUgaW50ZXJuYWwgZGF0YQotICogQGtyZWY6CVJlZmVyZW5jZSBj
b3VudC4KKyAqIEBkZXY6CVRoZSB3YXRjaGRvZydzIGludGVybmFsIGRldmljZQogICogQGNkZXY6
CVRoZSB3YXRjaGRvZydzIENoYXJhY3RlciBkZXZpY2UuCiAgKiBAd2RkOglQb2ludGVyIHRvIHdh
dGNoZG9nIGRldmljZS4KICAqIEBsb2NrOglMb2NrIGZvciB3YXRjaGRvZyBjb3JlLgogICogQHN0
YXR1czoJV2F0Y2hkb2cgY29yZSBpbnRlcm5hbCBzdGF0dXMgYml0cy4KICAqLwogc3RydWN0IHdh
dGNoZG9nX2NvcmVfZGF0YSB7Ci0Jc3RydWN0IGtyZWYga3JlZjsKKwlzdHJ1Y3QgZGV2aWNlIGRl
djsKIAlzdHJ1Y3QgY2RldiBjZGV2OwogCXN0cnVjdCB3YXRjaGRvZ19kZXZpY2UgKndkZDsKIAlz
dHJ1Y3QgbXV0ZXggbG9jazsKQEAgLTgwMiw3ICs4MDEsNyBAQCBzdGF0aWMgaW50IHdhdGNoZG9n
X29wZW4oc3RydWN0IGlub2RlICppbm9kZSwgc3RydWN0IGZpbGUgKmZpbGUpCiAJZmlsZS0+cHJp
dmF0ZV9kYXRhID0gd2RfZGF0YTsKIAogCWlmICghaHdfcnVubmluZykKLQkJa3JlZl9nZXQoJndk
X2RhdGEtPmtyZWYpOworCQlnZXRfZGV2aWNlKCZ3ZF9kYXRhLT5kZXYpOwogCiAJLyogZGV2L3dh
dGNoZG9nIGlzIGEgdmlydHVhbCAoYW5kIHRodXMgbm9uLXNlZWthYmxlKSBmaWxlc3lzdGVtICov
CiAJcmV0dXJuIG5vbnNlZWthYmxlX29wZW4oaW5vZGUsIGZpbGUpOwpAQCAtODE0LDExICs4MTMs
MTEgQEAgc3RhdGljIGludCB3YXRjaGRvZ19vcGVuKHN0cnVjdCBpbm9kZSAqaW5vZGUsIHN0cnVj
dCBmaWxlICpmaWxlKQogCXJldHVybiBlcnI7CiB9CiAKLXN0YXRpYyB2b2lkIHdhdGNoZG9nX2Nv
cmVfZGF0YV9yZWxlYXNlKHN0cnVjdCBrcmVmICprcmVmKQorc3RhdGljIHZvaWQgd2F0Y2hkb2df
Y29yZV9kYXRhX3JlbGVhc2Uoc3RydWN0IGRldmljZSAqZGV2KQogewogCXN0cnVjdCB3YXRjaGRv
Z19jb3JlX2RhdGEgKndkX2RhdGE7CiAKLQl3ZF9kYXRhID0gY29udGFpbmVyX29mKGtyZWYsIHN0
cnVjdCB3YXRjaGRvZ19jb3JlX2RhdGEsIGtyZWYpOworCXdkX2RhdGEgPSBjb250YWluZXJfb2Yo
ZGV2LCBzdHJ1Y3Qgd2F0Y2hkb2dfY29yZV9kYXRhLCBkZXYpOwogCiAJa2ZyZWUod2RfZGF0YSk7
CiB9CkBAIC04NzgsNyArODc3LDcgQEAgc3RhdGljIGludCB3YXRjaGRvZ19yZWxlYXNlKHN0cnVj
dCBpbm9kZSAqaW5vZGUsIHN0cnVjdCBmaWxlICpmaWxlKQogCSAqLwogCWlmICghcnVubmluZykg
ewogCQltb2R1bGVfcHV0KHdkX2RhdGEtPmNkZXYub3duZXIpOwotCQlrcmVmX3B1dCgmd2RfZGF0
YS0+a3JlZiwgd2F0Y2hkb2dfY29yZV9kYXRhX3JlbGVhc2UpOworCQlwdXRfZGV2aWNlKCZ3ZF9k
YXRhLT5kZXYpOwogCX0KIAlyZXR1cm4gMDsKIH0KQEAgLTg5NywxNyArODk2LDIyIEBAIHN0YXRp
YyBzdHJ1Y3QgbWlzY2RldmljZSB3YXRjaGRvZ19taXNjZGV2ID0gewogCS5mb3BzCQk9ICZ3YXRj
aGRvZ19mb3BzLAogfTsKIAorc3RhdGljIHN0cnVjdCBjbGFzcyB3YXRjaGRvZ19jbGFzcyA9IHsK
KwkubmFtZSA9CQkid2F0Y2hkb2ciLAorCS5vd25lciA9CVRISVNfTU9EVUxFLAorCS5kZXZfZ3Jv
dXBzID0Jd2R0X2dyb3VwcywKK307CisKIC8qCiAgKgl3YXRjaGRvZ19jZGV2X3JlZ2lzdGVyOiBy
ZWdpc3RlciB3YXRjaGRvZyBjaGFyYWN0ZXIgZGV2aWNlCiAgKglAd2RkOiB3YXRjaGRvZyBkZXZp
Y2UKLSAqCUBkZXZubzogY2hhcmFjdGVyIGRldmljZSBudW1iZXIKICAqCiAgKglSZWdpc3RlciBh
IHdhdGNoZG9nIGNoYXJhY3RlciBkZXZpY2UgaW5jbHVkaW5nIGhhbmRsaW5nIHRoZSBsZWdhY3kK
ICAqCS9kZXYvd2F0Y2hkb2cgbm9kZS4gL2Rldi93YXRjaGRvZyBpcyBhY3R1YWxseSBhIG1pc2Nk
ZXZpY2UgYW5kCiAgKgl0aHVzIHdlIHNldCBpdCB1cCBsaWtlIHRoYXQuCiAgKi8KIAotc3RhdGlj
IGludCB3YXRjaGRvZ19jZGV2X3JlZ2lzdGVyKHN0cnVjdCB3YXRjaGRvZ19kZXZpY2UgKndkZCwg
ZGV2X3QgZGV2bm8pCitzdGF0aWMgaW50IHdhdGNoZG9nX2NkZXZfcmVnaXN0ZXIoc3RydWN0IHdh
dGNoZG9nX2RldmljZSAqd2RkKQogewogCXN0cnVjdCB3YXRjaGRvZ19jb3JlX2RhdGEgKndkX2Rh
dGE7CiAJaW50IGVycjsKQEAgLTkxNSw3ICs5MTksNiBAQCBzdGF0aWMgaW50IHdhdGNoZG9nX2Nk
ZXZfcmVnaXN0ZXIoc3RydWN0IHdhdGNoZG9nX2RldmljZSAqd2RkLCBkZXZfdCBkZXZubykKIAl3
ZF9kYXRhID0ga3phbGxvYyhzaXplb2Yoc3RydWN0IHdhdGNoZG9nX2NvcmVfZGF0YSksIEdGUF9L
RVJORUwpOwogCWlmICghd2RfZGF0YSkKIAkJcmV0dXJuIC1FTk9NRU07Ci0Ja3JlZl9pbml0KCZ3
ZF9kYXRhLT5rcmVmKTsKIAltdXRleF9pbml0KCZ3ZF9kYXRhLT5sb2NrKTsKIAogCXdkX2RhdGEt
PndkZCA9IHdkZDsKQEAgLTk0MiwyMyArOTQ1LDMzIEBAIHN0YXRpYyBpbnQgd2F0Y2hkb2dfY2Rl
dl9yZWdpc3RlcihzdHJ1Y3Qgd2F0Y2hkb2dfZGV2aWNlICp3ZGQsIGRldl90IGRldm5vKQogCQl9
CiAJfQogCisJZGV2aWNlX2luaXRpYWxpemUoJndkX2RhdGEtPmRldik7CisJd2RfZGF0YS0+ZGV2
LmRldnQgPSBNS0RFVihNQUpPUih3YXRjaGRvZ19kZXZ0KSwgd2RkLT5pZCk7CisJd2RfZGF0YS0+
ZGV2LmNsYXNzID0gJndhdGNoZG9nX2NsYXNzOworCXdkX2RhdGEtPmRldi5wYXJlbnQgPSB3ZGQt
PnBhcmVudDsKKwl3ZF9kYXRhLT5kZXYuZ3JvdXBzID0gd2RkLT5ncm91cHM7CisJd2RfZGF0YS0+
ZGV2LnJlbGVhc2UgPSB3YXRjaGRvZ19jb3JlX2RhdGFfcmVsZWFzZTsKKwlkZXZfc2V0X2RydmRh
dGEoJndkX2RhdGEtPmRldiwgd2RkKTsKKwlkZXZfc2V0X25hbWUoJndkX2RhdGEtPmRldiwgIndh
dGNoZG9nJWQiLCB3ZGQtPmlkKTsKKwogCS8qIEZpbGwgaW4gdGhlIGRhdGEgc3RydWN0dXJlcyAq
LwogCWNkZXZfaW5pdCgmd2RfZGF0YS0+Y2RldiwgJndhdGNoZG9nX2ZvcHMpOwotCXdkX2RhdGEt
PmNkZXYub3duZXIgPSB3ZGQtPm9wcy0+b3duZXI7CiAKIAkvKiBBZGQgdGhlIGRldmljZSAqLwot
CWVyciA9IGNkZXZfYWRkKCZ3ZF9kYXRhLT5jZGV2LCBkZXZubywgMSk7CisJZXJyID0gY2Rldl9k
ZXZpY2VfYWRkKCZ3ZF9kYXRhLT5jZGV2LCAmd2RfZGF0YS0+ZGV2KTsKIAlpZiAoZXJyKSB7CiAJ
CXByX2Vycigid2F0Y2hkb2clZCB1bmFibGUgdG8gYWRkIGRldmljZSAlZDolZFxuIiwKIAkJCXdk
ZC0+aWQsICBNQUpPUih3YXRjaGRvZ19kZXZ0KSwgd2RkLT5pZCk7CiAJCWlmICh3ZGQtPmlkID09
IDApIHsKIAkJCW1pc2NfZGVyZWdpc3Rlcigmd2F0Y2hkb2dfbWlzY2Rldik7CiAJCQlvbGRfd2Rf
ZGF0YSA9IE5VTEw7Ci0JCQlrcmVmX3B1dCgmd2RfZGF0YS0+a3JlZiwgd2F0Y2hkb2dfY29yZV9k
YXRhX3JlbGVhc2UpOworCQkJcHV0X2RldmljZSgmd2RfZGF0YS0+ZGV2KTsKIAkJfQogCQlyZXR1
cm4gZXJyOwogCX0KIAorCXdkX2RhdGEtPmNkZXYub3duZXIgPSB3ZGQtPm9wcy0+b3duZXI7CisK
IAkvKiBSZWNvcmQgdGltZSBvZiBtb3N0IHJlY2VudCBoZWFydGJlYXQgYXMgJ2p1c3QgYmVmb3Jl
IG5vdycuICovCiAJd2RfZGF0YS0+bGFzdF9od19rZWVwYWxpdmUgPSBqaWZmaWVzIC0gMTsKIApA
QCAtOTY4LDcgKzk4MSw3IEBAIHN0YXRpYyBpbnQgd2F0Y2hkb2dfY2Rldl9yZWdpc3RlcihzdHJ1
Y3Qgd2F0Y2hkb2dfZGV2aWNlICp3ZGQsIGRldl90IGRldm5vKQogCSAqLwogCWlmICh3YXRjaGRv
Z19od19ydW5uaW5nKHdkZCkpIHsKIAkJX19tb2R1bGVfZ2V0KHdkZC0+b3BzLT5vd25lcik7Ci0J
CWtyZWZfZ2V0KCZ3ZF9kYXRhLT5rcmVmKTsKKwkJZ2V0X2RldmljZSgmd2RfZGF0YS0+ZGV2KTsK
IAkJaWYgKGhhbmRsZV9ib290X2VuYWJsZWQpCiAJCQlxdWV1ZV9kZWxheWVkX3dvcmsod2F0Y2hk
b2dfd3EsICZ3ZF9kYXRhLT53b3JrLCAwKTsKIAkJZWxzZQpAQCAtOTkxLDcgKzEwMDQsNyBAQCBz
dGF0aWMgdm9pZCB3YXRjaGRvZ19jZGV2X3VucmVnaXN0ZXIoc3RydWN0IHdhdGNoZG9nX2Rldmlj
ZSAqd2RkKQogewogCXN0cnVjdCB3YXRjaGRvZ19jb3JlX2RhdGEgKndkX2RhdGEgPSB3ZGQtPndk
X2RhdGE7CiAKLQljZGV2X2RlbCgmd2RfZGF0YS0+Y2Rldik7CisJY2Rldl9kZXZpY2VfZGVsKCZ3
ZF9kYXRhLT5jZGV2LCAmd2RfZGF0YS0+ZGV2KTsKIAlpZiAod2RkLT5pZCA9PSAwKSB7CiAJCW1p
c2NfZGVyZWdpc3Rlcigmd2F0Y2hkb2dfbWlzY2Rldik7CiAJCW9sZF93ZF9kYXRhID0gTlVMTDsK
QEAgLTEwMDksMTUgKzEwMjIsOSBAQCBzdGF0aWMgdm9pZCB3YXRjaGRvZ19jZGV2X3VucmVnaXN0
ZXIoc3RydWN0IHdhdGNoZG9nX2RldmljZSAqd2RkKQogCiAJY2FuY2VsX2RlbGF5ZWRfd29ya19z
eW5jKCZ3ZF9kYXRhLT53b3JrKTsKIAotCWtyZWZfcHV0KCZ3ZF9kYXRhLT5rcmVmLCB3YXRjaGRv
Z19jb3JlX2RhdGFfcmVsZWFzZSk7CisJcHV0X2RldmljZSgmd2RfZGF0YS0+ZGV2KTsKIH0KIAot
c3RhdGljIHN0cnVjdCBjbGFzcyB3YXRjaGRvZ19jbGFzcyA9IHsKLQkubmFtZSA9CQkid2F0Y2hk
b2ciLAotCS5vd25lciA9CVRISVNfTU9EVUxFLAotCS5kZXZfZ3JvdXBzID0Jd2R0X2dyb3VwcywK
LX07Ci0KIC8qCiAgKgl3YXRjaGRvZ19kZXZfcmVnaXN0ZXI6IHJlZ2lzdGVyIGEgd2F0Y2hkb2cg
ZGV2aWNlCiAgKglAd2RkOiB3YXRjaGRvZyBkZXZpY2UKQEAgLTEwMjksMjcgKzEwMzYsMTQgQEAg
c3RhdGljIHN0cnVjdCBjbGFzcyB3YXRjaGRvZ19jbGFzcyA9IHsKIAogaW50IHdhdGNoZG9nX2Rl
dl9yZWdpc3RlcihzdHJ1Y3Qgd2F0Y2hkb2dfZGV2aWNlICp3ZGQpCiB7Ci0Jc3RydWN0IGRldmlj
ZSAqZGV2OwotCWRldl90IGRldm5vOwogCWludCByZXQ7CiAKLQlkZXZubyA9IE1LREVWKE1BSk9S
KHdhdGNoZG9nX2RldnQpLCB3ZGQtPmlkKTsKLQotCXJldCA9IHdhdGNoZG9nX2NkZXZfcmVnaXN0
ZXIod2RkLCBkZXZubyk7CisJcmV0ID0gd2F0Y2hkb2dfY2Rldl9yZWdpc3Rlcih3ZGQpOwogCWlm
IChyZXQpCiAJCXJldHVybiByZXQ7CiAKLQlkZXYgPSBkZXZpY2VfY3JlYXRlX3dpdGhfZ3JvdXBz
KCZ3YXRjaGRvZ19jbGFzcywgd2RkLT5wYXJlbnQsCi0JCQkJCWRldm5vLCB3ZGQsIHdkZC0+Z3Jv
dXBzLAotCQkJCQkid2F0Y2hkb2clZCIsIHdkZC0+aWQpOwotCWlmIChJU19FUlIoZGV2KSkgewot
CQl3YXRjaGRvZ19jZGV2X3VucmVnaXN0ZXIod2RkKTsKLQkJcmV0dXJuIFBUUl9FUlIoZGV2KTsK
LQl9Ci0KIAlyZXQgPSB3YXRjaGRvZ19yZWdpc3Rlcl9wcmV0aW1lb3V0KHdkZCk7CiAJaWYgKHJl
dCkgewotCQlkZXZpY2VfZGVzdHJveSgmd2F0Y2hkb2dfY2xhc3MsIGRldm5vKTsKIAkJd2F0Y2hk
b2dfY2Rldl91bnJlZ2lzdGVyKHdkZCk7CiAJfQogCkBAIC0xMDY3LDcgKzEwNjEsNiBAQCBpbnQg
d2F0Y2hkb2dfZGV2X3JlZ2lzdGVyKHN0cnVjdCB3YXRjaGRvZ19kZXZpY2UgKndkZCkKIHZvaWQg
d2F0Y2hkb2dfZGV2X3VucmVnaXN0ZXIoc3RydWN0IHdhdGNoZG9nX2RldmljZSAqd2RkKQogewog
CXdhdGNoZG9nX3VucmVnaXN0ZXJfcHJldGltZW91dCh3ZGQpOwotCWRldmljZV9kZXN0cm95KCZ3
YXRjaGRvZ19jbGFzcywgd2RkLT53ZF9kYXRhLT5jZGV2LmRldik7CiAJd2F0Y2hkb2dfY2Rldl91
bnJlZ2lzdGVyKHdkZCk7CiB9CiAK


--=-dJFIrJ7v5edhGV7nkNrW--

