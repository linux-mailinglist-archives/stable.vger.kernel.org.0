Return-Path: <stable-owner@vger.kernel.org>
X-Original-To: lists+stable@lfdr.de
Delivered-To: lists+stable@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id 1A3EA3DD6DB
	for <lists+stable@lfdr.de>; Mon,  2 Aug 2021 15:20:47 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S233715AbhHBNUy (ORCPT <rfc822;lists+stable@lfdr.de>);
        Mon, 2 Aug 2021 09:20:54 -0400
Received: from mail.kernel.org ([198.145.29.99]:40710 "EHLO mail.kernel.org"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S233691AbhHBNUy (ORCPT <rfc822;stable@vger.kernel.org>);
        Mon, 2 Aug 2021 09:20:54 -0400
Received: from disco-boy.misterjones.org (disco-boy.misterjones.org [51.254.78.96])
        (using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
        (No client certificate requested)
        by mail.kernel.org (Postfix) with ESMTPSA id F08DE61108;
        Mon,  2 Aug 2021 13:20:44 +0000 (UTC)
Received: from sofa.misterjones.org ([185.219.108.64] helo=why.misterjones.org)
        by disco-boy.misterjones.org with esmtpsa  (TLS1.3) tls TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
        (Exim 4.94.2)
        (envelope-from <maz@kernel.org>)
        id 1mAXs2-002SNp-Tz; Mon, 02 Aug 2021 14:20:43 +0100
Date:   Mon, 02 Aug 2021 14:20:42 +0100
Message-ID: <87mtq00yqd.wl-maz@kernel.org>
From:   Marc Zyngier <maz@kernel.org>
To:     Quentin Perret <qperret@google.com>
Cc:     kvm@vger.kernel.org, kvmarm@lists.cs.columbia.edu,
        linux-arm-kernel@lists.infradead.org,
        James Morse <james.morse@arm.com>,
        Suzuki K Poulose <suzuki.poulose@arm.com>,
        Alexandru Elisei <alexandru.elisei@arm.com>,
        Will Deacon <will@kernel.org>,
        Catalin Marinas <catalin.marinas@arm.com>,
        kernel-team@android.com, stable@vger.kernel.org
Subject: Re: [PATCH v2 1/2] arm64: Move .hyp.rodata outside of the _sdata.._edata range
In-Reply-To: <YQfu6+3uo6qlxrpv@google.com>
References: <20210802123830.2195174-1-maz@kernel.org>
        <20210802123830.2195174-2-maz@kernel.org>
        <YQfu6+3uo6qlxrpv@google.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
 FLIM-LB/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL-LB/10.8 EasyPG/1.0.0 Emacs/27.1
 (x86_64-pc-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
X-SA-Exim-Connect-IP: 185.219.108.64
X-SA-Exim-Rcpt-To: qperret@google.com, kvm@vger.kernel.org, kvmarm@lists.cs.columbia.edu, linux-arm-kernel@lists.infradead.org, james.morse@arm.com, suzuki.poulose@arm.com, alexandru.elisei@arm.com, will@kernel.org, catalin.marinas@arm.com, kernel-team@android.com, stable@vger.kernel.org
X-SA-Exim-Mail-From: maz@kernel.org
X-SA-Exim-Scanned: No (on disco-boy.misterjones.org); SAEximRunCond expanded to false
Precedence: bulk
List-ID: <stable.vger.kernel.org>
X-Mailing-List: stable@vger.kernel.org

Hi Quentin,

On Mon, 02 Aug 2021 14:11:07 +0100,
Quentin Perret <qperret@google.com> wrote:
> 
> Hi Marc,
> 
> On Monday 02 Aug 2021 at 13:38:29 (+0100), Marc Zyngier wrote:
> > The HYP rodata section is currently lumped together with the BSS,
> > which isn't exactly what is expected (it gets registered with
> > kmemleak, for example).
> > 
> > Move it away so that it is actually marked RO. As an added
> > benefit, it isn't registered with kmemleak anymore.
> 
> 2d7bf218ca73 ("KVM: arm64: Add .hyp.data..ro_after_init ELF section")
> states explicitly that the hyp ro_after_init section should remain RW in
> the host as it is expected to modify it before initializing EL2. But I
> can't seem to trigger anything with this patch applied, so I'll look
> into this a bit more.

The switch to RO happens quite late. And if the host was to actually
try and change things there, it would be screwed anyway (we will have
already removed the pages from its S2).

I wouldn't be surprised if this was a consequence of the way we now
build the HYP object, and the comment in the original commit may not
be valid anymore.

> 
> > Fixes: 380e18ade4a5 ("KVM: arm64: Introduce a BSS section for use at Hyp")
> 
> Not sure this is the patch to blame?

My bad, this is plain wrong. I'm not sure it can be applied earlier
though if my rambling above is correct.

Thanks,

	M.

-- 
Without deviation from the norm, progress is not possible.
